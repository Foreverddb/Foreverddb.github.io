<!DOCTYPE HTML>
<html>

<head>
	<link rel="bookmark"  type="image/x-icon"  href="/img/logo_miccall.png"/>
	<link rel="shortcut icon" href="/img/logo_miccall.png">
	
			    <title>
    DdB'S BLOG
    </title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="/css/mic_main.css" />
    <link rel="stylesheet" href="/css/dropdownMenu.css" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>

    <meta name="keywords" content="ddb" />
    
    	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	 
    <noscript>
        <link rel="stylesheet" href="/css/noscript.css" />
    </noscript>
    <style type="text/css">
        body:before {
          content: ' ';
          position: fixed;
          top: 0;
          background: url('/img/bg.jpg') center 0 no-repeat;
          right: 0;
          bottom: 0;
          left: 0;
          background-size: cover; 
        }
    </style>

			    
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script async type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery.scrollex.min.js"></script>
    <script src="/js/jquery.scrolly.min.js"></script>
    <script src="/js/skel.min.js"></script>
    <script src="/js/util.js"></script>
    <script src="/js/main.js"></script>
	
<meta name="generator" content="Hexo 5.4.0"></head>
    
		
<!-- Layouts -->



<!--  代码渲染  -->
<link rel="stylesheet" href="/css/prism_coy.css" />
<link rel="stylesheet" href="/css/typo.css" />
<!-- 文章页 -->
<body class="is-loading">
    <!-- Wrapper 外包 s-->
    <div id="wrapper" class="fade-in">
        <!-- Intro 头部显示 s -->
        <!-- Intro 头部显示 e -->
        <!-- Header 头部logo start -->
        <header id="header">
    <a href="/" class="logo">ForeverDdB</a>
</header>
        <!-- Nav 导航条 start -->
        <nav id="nav" class="special" >
            <ul class="menu links" >
			<!-- Homepage  主页  --> 
			<li >
	            <a href="/" rel="nofollow">主页</a>
	        </li>
			<!-- categories_name  分类   --> 
	        
	        <li class="active">
	            <a href="#s1">分类</a>
	                    <ul class="submenu">
	                        <li>
	                        <a class="category-link" href="/categories/%E6%90%9E%E6%9C%BA/">搞机</a></li><li><a class="category-link" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a>
	                    </ul>
	        </li>
	        
	        <!-- archives  归档   --> 
	        
	        <li class="active">
	            <a href="#s1">归档</a>
	                    <ul class="submenu">
	                        <li>
	                        <a class="archive-link" href="/archives/2023/08/">八月 2023</a></li><li><a class="archive-link" href="/archives/2023/06/">六月 2023</a></li><li><a class="archive-link" href="/archives/2023/04/">四月 2023</a></li><li><a class="archive-link" href="/archives/2022/03/">三月 2022</a></li><li><a class="archive-link" href="/archives/2021/09/">九月 2021</a></li><li><a class="archive-link" href="/archives/2021/08/">八月 2021</a></li><li><a class="archive-link" href="/archives/2021/06/">六月 2021</a>
	                    </ul>
	        </li>
	        
	        
		        <!-- Pages 自定义   -->
		        
		        <li>
		            <a href="/about/" title="个人">
		                个人
		            </a>
		        </li>
		        
		        <li>
		            <a target="_blank" rel="noopener" href="https://img.foreverddb.top" title="图库">
		                图库
		            </a>
		        </li>
		        


            </ul>
            <!-- icons 图标   -->
			<ul class="icons">
                    
                    <li>
                        <a title="github" href="https://github.com/foreverddb" target="_blank" rel="noopener">
                            <i class="icon fa fa-github"></i>
                        </a>
                    </li>
                    
			</ul>
</nav>

        <div id="main" >
            <div class ="post_page_title_img" style="height: 25rem;background-image: url(/img/cnss.png);background-position: center; background-repeat:no-repeat; background-size:cover;-moz-background-size:cover;overflow:hidden;" >
                <a href="#" style="padding: 4rem 4rem 2rem 4rem ;"><h2 >CNSS Recruit 2022 Reverse Writeup</h2></a>
            </div>
            <!-- Post -->
            <div class="typo" style="padding: 3rem;">
                <h1 id="CNSS-Recruit-2022-Reverse-Writeup"><a href="#CNSS-Recruit-2022-Reverse-Writeup" class="headerlink" title="CNSS Recruit 2022 Reverse Writeup"></a>CNSS Recruit 2022 Reverse Writeup</h1><p>为什么现在才发出来，因为去年之后就一直忘了，直到今年夏令营开了才想起来去年还写过这个，就权当发出来记录一下吧。</p>
<p>大二上零re基础肝了一个月，确实是啥也不会，cnss里全都是大佬，萌新瑟瑟发抖。</p>
<p>果然因为基础知识太差加上学习不用心最后还是挂了，不过确实是一次有趣而难忘的体验。</p>
<h2 id="Baby-Find-me"><a href="#Baby-Find-me" class="headerlink" title="[Baby] Find me"></a>[Baby] Find me</h2><p>根据提示，打开strings窗口，发现第一段flag和最后一段flag。</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20220930141106314.png" alt="image-20220930141106314"></p>
<p>在函数窗口里找到第二段flag，（感觉挺阴间的，找了半天各种搜flag，谁知道竟然直接把flag的内容当函数名啊！）</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20220930141307509.png" alt="image-20220930141307509"></p>
<p>第三段根据提示点开<code>Find out which function refer to me!</code>，对其按x找到引用，上面写的就是第三段flag：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20220930141441097.png" alt="image-20220930141441097"></p>
<h2 id="Easy-回レ-雪月花"><a href="#Easy-回レ-雪月花" class="headerlink" title="[Easy] 回レ! 雪月花"></a>[Easy] 回レ! 雪月花</h2><p>（这里是后面分析的，最开始嫌分析麻烦就直接顺着逻辑用约束求解器做的）</p>
<p>分析得到这是通过对一段字符进行异或和移位操作，于是反向过来得到flag：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> cipher<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0x3F</span><span class="token punctuation">,</span> <span class="token number">0x8F</span><span class="token punctuation">,</span> <span class="token number">0xA3</span><span class="token punctuation">,</span> <span class="token number">0xBC</span><span class="token punctuation">,</span> <span class="token number">0x8D</span><span class="token punctuation">,</span> <span class="token number">0x27</span><span class="token punctuation">,</span> <span class="token number">0x7A</span><span class="token punctuation">,</span> <span class="token number">0x67</span><span class="token punctuation">,</span> <span class="token number">0xE2</span><span class="token punctuation">,</span> <span class="token number">0x3</span><span class="token punctuation">,</span>
          <span class="token number">0xA2</span><span class="token punctuation">,</span> <span class="token number">0xE0</span><span class="token punctuation">,</span> <span class="token number">0xAC</span><span class="token punctuation">,</span> <span class="token number">0xEA</span><span class="token punctuation">,</span> <span class="token number">0x95</span><span class="token punctuation">,</span> <span class="token number">0x8B</span><span class="token punctuation">,</span> <span class="token number">0xA3</span><span class="token punctuation">,</span> <span class="token number">0xED</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span>
          <span class="token number">0xB6</span><span class="token punctuation">,</span> <span class="token number">0x32</span><span class="token punctuation">,</span> <span class="token number">0x8C</span><span class="token punctuation">,</span> <span class="token number">0x94</span><span class="token punctuation">,</span> <span class="token number">0x52</span><span class="token punctuation">,</span> <span class="token number">0x82</span><span class="token punctuation">,</span> <span class="token number">0x8A</span><span class="token punctuation">,</span> <span class="token number">0x14</span><span class="token punctuation">,</span> <span class="token number">0xC6</span><span class="token punctuation">,</span> <span class="token number">0xF5</span><span class="token punctuation">,</span> <span class="token number">0xAE</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token number">0x73</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">28</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">char</span> v1<span class="token punctuation">,</span>v2<span class="token punctuation">,</span>v3<span class="token punctuation">,</span>v4<span class="token punctuation">;</span>
        v1 <span class="token operator">=</span> <span class="token punctuation">(</span>cipher<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">>></span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cipher<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">^</span> cipher<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        v2 <span class="token operator">=</span> <span class="token punctuation">(</span>cipher<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cipher<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">^</span> cipher<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        v3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cipher<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">^</span> cipher<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cipher<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">^</span> cipher<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        v4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cipher<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">^</span> cipher<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cipher<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">^</span> cipher<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        cipher<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> v1<span class="token punctuation">;</span>
        cipher<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> v2<span class="token punctuation">;</span>
        cipher<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> v3<span class="token punctuation">;</span>
        cipher<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> v4<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span>  j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  j <span class="token operator">&lt;=</span> <span class="token number">31</span> <span class="token punctuation">;</span> <span class="token operator">++</span> j<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        cipher<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">^=</span> <span class="token number">0x11</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> cipher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>对于这种计算量不是特别大的情况，懒得分析就直接用约束求解器（类似于一个解方程的计算器）来算，直接按照原逻辑写一遍，然后最后把判等条件传给求解器即可解出。这个我写的过程出现了一些问题导致无法求解，即python里没有严格的类型来限制数据的位数，导致向左移位时最高位不会被舍去，所以要通过和0xff进行与运算来舍去8位以上的位。</p>
<p>使用python里的一个约束求解器<code>z3py</code>（夏令营学到的）</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> z3 <span class="token keyword">import</span> <span class="token operator">*</span>
b <span class="token operator">=</span> <span class="token number">0x11</span>

cipher <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x3F</span><span class="token punctuation">,</span> <span class="token number">0x8F</span><span class="token punctuation">,</span> <span class="token number">0xA3</span><span class="token punctuation">,</span> <span class="token number">0xBC</span><span class="token punctuation">,</span> <span class="token number">0x8D</span><span class="token punctuation">,</span> <span class="token number">0x27</span><span class="token punctuation">,</span> <span class="token number">0x7A</span><span class="token punctuation">,</span> <span class="token number">0x67</span><span class="token punctuation">,</span> <span class="token number">0xE2</span><span class="token punctuation">,</span> <span class="token number">0x3</span><span class="token punctuation">,</span>
          <span class="token number">0xA2</span><span class="token punctuation">,</span> <span class="token number">0xE0</span><span class="token punctuation">,</span> <span class="token number">0xAC</span><span class="token punctuation">,</span> <span class="token number">0xEA</span><span class="token punctuation">,</span> <span class="token number">0x95</span><span class="token punctuation">,</span> <span class="token number">0x8B</span><span class="token punctuation">,</span> <span class="token number">0xA3</span><span class="token punctuation">,</span> <span class="token number">0xED</span><span class="token punctuation">,</span> <span class="token number">0xCC</span><span class="token punctuation">,</span>
          <span class="token number">0xB6</span><span class="token punctuation">,</span> <span class="token number">0x32</span><span class="token punctuation">,</span> <span class="token number">0x8C</span><span class="token punctuation">,</span> <span class="token number">0x94</span><span class="token punctuation">,</span> <span class="token number">0x52</span><span class="token punctuation">,</span> <span class="token number">0x82</span><span class="token punctuation">,</span> <span class="token number">0x8A</span><span class="token punctuation">,</span> <span class="token number">0x14</span><span class="token punctuation">,</span> <span class="token number">0xC6</span><span class="token punctuation">,</span> <span class="token number">0xF5</span><span class="token punctuation">,</span> <span class="token number">0xAE</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token number">0x73</span><span class="token punctuation">]</span>
flag <span class="token operator">=</span> cipher

thef <span class="token operator">=</span> <span class="token punctuation">[</span>z3<span class="token punctuation">.</span>BitVec<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'x</span><span class="token interpolation"><span class="token punctuation">&#123;</span>i<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
s <span class="token operator">=</span> Solver<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    thef<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span><span class="token operator">=</span> <span class="token number">0x11</span>
    thef<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token number">0xff</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    v5 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>thef<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>thef<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span>
    v6 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>thef<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">>></span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>thef<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> v5<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span>
    v7 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>thef<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>thef<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> v6<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span>
    v8 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>thef<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">>></span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>thef<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> v7<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span>
    thef<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> v5
    thef<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> v6
    thef<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> v7
    thef<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> v8

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    s<span class="token punctuation">.</span>add<span class="token punctuation">(</span>thef<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> cipher<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> s<span class="token punctuation">.</span>check<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> sat<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>model<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Easy-邪王真眼"><a href="#Easy-邪王真眼" class="headerlink" title="[Easy] 邪王真眼"></a>[Easy] 邪王真眼</h2><p>ida打开发现了一串字符串<code>abcd4EFGHij8k0lMNOPqr6stU91VWXyz7+/ABCDefg2hI5JKLmnopQRST3uvwxYZ</code>。一眼丁真鉴定为：base64的字母表，然后再找strings找到密文：<code>UR3oWS5E0G03tRibWRrR0cEx</code></p>
<p>用一个自定义字母表的base64解密函数即可得到flag：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">letters <span class="token operator">=</span> <span class="token string">"abcd4EFGHij8k0lMNOPqr6stU91VWXyz7+/ABCDefg2hI5JKLmnopQRST3uvwxYZ"</span>

<span class="token comment">#定义base64加密函数</span>
<span class="token keyword">def</span> <span class="token function">encryption</span><span class="token punctuation">(</span>inputString<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 对每一个字节取ascii数值或unicode数值，然后转换为2进制</span>
    <span class="token builtin">ascii</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'&#123;:0>8&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">bin</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'0b'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
             <span class="token keyword">for</span> i <span class="token keyword">in</span> inputString<span class="token punctuation">]</span>
    <span class="token comment">#返回的加密文本</span>
    outputString <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token comment"># 不够3字节的整数倍，需要补齐“=”的个数</span>
    equalNumber <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment">#对每个字符的转换</span>
    <span class="token keyword">while</span> <span class="token builtin">ascii</span><span class="token punctuation">:</span>
        <span class="token comment">#三个asciiw为一组</span>
        AsciiList <span class="token operator">=</span> <span class="token builtin">ascii</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>AsciiList<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">:</span>
            <span class="token comment">#不满三个的，在后面加“=”</span>
            <span class="token keyword">while</span> <span class="token builtin">len</span><span class="token punctuation">(</span>AsciiList<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">:</span>
                equalNumber <span class="token operator">+=</span> <span class="token number">1</span>
                AsciiList <span class="token operator">+=</span> <span class="token punctuation">[</span><span class="token string">'0'</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">]</span>
        <span class="token comment">#join方法连接成三个8字节的字符串</span>
        tempString <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>AsciiList<span class="token punctuation">)</span>
        <span class="token comment"># 三个8字节的二进制，转换为4个6字节的二进制</span>
        tempStringList <span class="token operator">=</span> <span class="token punctuation">[</span>tempString<span class="token punctuation">[</span>x<span class="token punctuation">:</span>x<span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token comment"># 二进制转为10进制</span>
        tempStringList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> tempStringList<span class="token punctuation">]</span>
        <span class="token comment"># 判断是否需要补“=”,只要equakNumber大于0即需要</span>
        <span class="token keyword">if</span> equalNumber<span class="token punctuation">:</span>
            tempStringList <span class="token operator">=</span> tempStringList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token operator">-</span>equalNumber<span class="token punctuation">]</span>
        <span class="token comment">#装换成那64个字符</span>
        outputString <span class="token operator">+=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>letters<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> tempStringList<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token builtin">ascii</span> <span class="token operator">=</span> <span class="token builtin">ascii</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token comment">#在最后加上“=”</span>
    outputString <span class="token operator">=</span> outputString <span class="token operator">+</span> <span class="token string">'='</span> <span class="token operator">*</span> equalNumber
    <span class="token comment">#返回加密后的文本</span>
    <span class="token keyword">return</span> outputString

<span class="token comment">#定义base64解密函数</span>
<span class="token keyword">def</span> <span class="token function">decryption</span><span class="token punctuation">(</span>inputString<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 对前面不是“=”的字节取索引，然后转换为2进制</span>
    asciiList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'&#123;:0>6&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">bin</span><span class="token punctuation">(</span>letters<span class="token punctuation">.</span>index<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'0b'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                      <span class="token keyword">for</span> i <span class="token keyword">in</span> inputString <span class="token keyword">if</span> i <span class="token operator">!=</span> <span class="token string">'='</span><span class="token punctuation">]</span>
    outputString <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token comment">#补齐“=”的个数</span>
    equalNumber <span class="token operator">=</span> inputString<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> asciiList<span class="token punctuation">:</span>
        tempList <span class="token operator">=</span> asciiList<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
        <span class="token comment">#转换成2进制字符串</span>
        tempString <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>tempList<span class="token punctuation">)</span>
        <span class="token comment"># 对没有8位2进制的字符串补够8位2进制</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tempString<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">8</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
            tempString <span class="token operator">=</span> tempString<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">*</span>equalNumber<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">]</span>
        <span class="token comment"># 4个6字节的二进制  转换  为三个8字节的二进制</span>
        tempStringList <span class="token operator">=</span> <span class="token punctuation">[</span>tempString<span class="token punctuation">[</span>x<span class="token punctuation">:</span>x<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token comment"># 二进制转为10进制</span>
        tempStringList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> tempStringList <span class="token keyword">if</span> x<span class="token punctuation">]</span>
        <span class="token comment">#连接成字符串</span>
        outputString <span class="token operator">+=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">chr</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> tempStringList<span class="token punctuation">]</span><span class="token punctuation">)</span>
        asciiList <span class="token operator">=</span> asciiList<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token comment">#print(output_str)</span>
    <span class="token keyword">return</span> outputString

flag <span class="token operator">=</span> <span class="token string">'cnss&#123;xxxx&#125;'</span>
<span class="token comment">#加密</span>
encryptedText <span class="token operator">=</span> encryption<span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"加密文本为："</span><span class="token operator">+</span>encryptedText<span class="token punctuation">)</span>
<span class="token comment">#解密</span>
decryptedText <span class="token operator">=</span> decryption<span class="token punctuation">(</span><span class="token string">"UR3oWS5E0G03tRibWRrR0cEx"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"解密文本为："</span><span class="token operator">+</span>decryptedText<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Easy-恭喜你获得了flag提现机会！"><a href="#Easy-恭喜你获得了flag提现机会！" class="headerlink" title="[Easy] 恭喜你获得了flag提现机会！"></a>[Easy] 恭喜你获得了flag提现机会！</h2><p>发现使用了一个永远减不到0的函数，而只有v6到了0才会打印flag。</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20220926111806523.png" alt="image-20220926111806523"></p>
<p>使用ida的<code>Patch Program</code>功能，因为发现输出flag就是使用了一个<code>outputflag</code>函数，所以直接跳过前面的条件判断调用这个函数就行。在最前面的地方，修改汇编代码为<code>call outputflag</code>：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20220926111651575.png" alt="image-20220926111651575"></p>
<p>可以看到在伪代码里已经是直接调用函数了。保存修改打开原exe文件即可得到flag。</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20220926111819735.png" alt="image-20220926111819735"></p>
<h2 id="Easy-diannaobaozhale"><a href="#Easy-diannaobaozhale" class="headerlink" title="[Easy+] diannaobaozhale"></a>[Easy+] diannaobaozhale</h2><p>这是一个读汇编源码的题，先看源码：</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">main            proc near

var_5           &#x3D; byte ptr -5
var_4           &#x3D; dword ptr -4

; __unwind &#123;
        endbr64
        push    rbp
        mov     rbp, rsp
        sub     rsp, 10h
        mov     [rbp+var_5], 63h
        mov     edi, 63h
        call    _putchar
        mov     edi, 6Eh
        call    _putchar
        mov     edi, 73h
        call    _putchar
        mov     edi, 73h
        call    _putchar
        mov     edi, 7Bh
        call    _putchar
        mov     [rbp+var_4], 0
        jmp     short loc_11B0
loc_1194:
        movsx   eax, [rbp+var_5]
        mov     edi, eax
        call    _putchar
        movzx   eax, [rbp+var_5]
        add     eax, 2
        xor     eax, 1
        mov     [rbp+var_5], al
        add     [rbp+var_4], 1
loc_11B0:
        cmp     [rbp+var_4], 9
        jle     short loc_1194
        mov     edi, 7Dh
        call    _putchar
        mov     eax, 0
        leave
        retn
; &#125;
main            endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>发现在<code>loc_11B0</code>中在循环调用<code>loc_1194</code>，而这个函数的操作就是对eax寄存器的指进行加2和对1异或。知道<code>edi</code>寄存器的值可以作为函数的第一个参数使用，根据这个调用putchar。</p>
<p>写出对应的c语言代码即可：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">char</span> c<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0x63</span><span class="token punctuation">,</span> <span class="token number">0x6E</span><span class="token punctuation">,</span> <span class="token number">0x73</span><span class="token punctuation">,</span> <span class="token number">0x73</span><span class="token punctuation">,</span> <span class="token number">0x7B</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> ax <span class="token operator">=</span> <span class="token number">0x63</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">while</span><span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">putchar</span><span class="token punctuation">(</span>ax<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ax <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        ax <span class="token operator">^=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        i <span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token number">0x7D</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Easy-Tell-me-your-secret"><a href="#Easy-Tell-me-your-secret" class="headerlink" title="[Easy+] Tell me your secret"></a>[Easy+] Tell me your secret</h2><p>ida打开发现了一堆if的判断语句，只要flag对应的不满足这个等式条件就返回wrong，所以需要顺着这一堆条件来写。首先对直接进行比较的部分进行直接赋值：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">char</span> v4<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token keyword">char</span> <span class="token operator">*</span>flag <span class="token operator">=</span> v4<span class="token punctuation">;</span>
   <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span>flag <span class="token operator">=</span> <span class="token number">0x6461626235363936</span><span class="token punctuation">;</span>
   <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>flag <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">892494177</span><span class="token punctuation">;</span>
   <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span>flag <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">26209</span><span class="token punctuation">;</span>
   <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span>flag <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">25906</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后发现后面使用一个函数对flag进行了处理再比较，点开这个函数：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">long</span> <span class="token function">sub_401629</span><span class="token punctuation">(</span><span class="token keyword">long</span> a1<span class="token punctuation">,</span> <span class="token keyword">int</span> a2<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">long</span> v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-10h]</span>
  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+1Ch] [rbp-4h]</span>

  v4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  v3 <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> v4 <span class="token operator">&lt;</span> a2 <span class="token punctuation">)</span>
    v3 <span class="token operator">=</span> <span class="token punctuation">(</span>v3 <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v4<span class="token operator">++</span> <span class="token operator">+</span> a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> v3<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>发现这个函数就是以字节为单位进行一个倒置，所以直接写出对应比较的16进制倒置数据：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">flag <span class="token operator">+=</span> <span class="token number">16</span><span class="token punctuation">;</span>
   <span class="token comment">// 原数据0x3233383136633364</span>
   <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span>flag <span class="token operator">=</span> <span class="token number">0x6433633631383332</span><span class="token punctuation">;</span>
   <span class="token comment">// 原数据0x39313934</span>
   <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>flag <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0x34393139</span><span class="token punctuation">;</span>
   <span class="token comment">// 原数据0x3330</span>
   <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span>flag <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0x3033</span><span class="token punctuation">;</span>
   <span class="token comment">// 原数据0x3163</span>
   <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span>flag <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0x6331</span><span class="token punctuation">;</span>
   flag <span class="token operator">-=</span> <span class="token number">16</span><span class="token punctuation">;</span>
   <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s \n"</span><span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Middle-Vip-of-Mihoyo"><a href="#Middle-Vip-of-Mihoyo" class="headerlink" title="[Middle] Vip of Mihoyo"></a>[Middle] Vip of Mihoyo</h2><p>虚拟机逆向，指的是自己实现一套指令系统，然后在此基础上运行字节码。于是ida反编译一下，先得到对应的opcode，然后反向每个指令的操作，从opcode末尾来逆向运行即可得出flag。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> opcode<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x394</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x3EC</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span>
        <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x314</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span>
        <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x314</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span>
        <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x354</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span>
        <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x2AC</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x33C</span><span class="token punctuation">,</span>
        <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x1CC</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span>
        <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x3D4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span>
        <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x274</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span>
        <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x22C</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0x0B</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span>
        <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x3E4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0x0C</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span>
        <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x274</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0x0D</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x124</span><span class="token punctuation">,</span>
        <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x31C</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0x0F</span><span class="token punctuation">,</span>
        <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x30C</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span>
        <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x224</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0x11</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span>
        <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x394</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0x12</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span>
        <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x31C</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0x13</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span>
        <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x20C</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0x14</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x324</span><span class="token punctuation">,</span>
        <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0x15</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x114</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0x16</span><span class="token punctuation">,</span>
        <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x184</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0x17</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span>
        <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0x0E</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0x0A</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0x364</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> v2<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">287</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> v5<span class="token punctuation">;</span>
    <span class="token keyword">int</span> v3<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">>=</span> <span class="token number">0</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>   
        v3 <span class="token operator">=</span> opcode<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>opcode<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
            v5 <span class="token operator">-=</span> v3<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> LABEL_16<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
            v5 <span class="token operator">/=</span> v3<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> LABEL_16<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
            v5 <span class="token operator">+=</span> v3<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> LABEL_16<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
            v5 <span class="token operator">*=</span> v3<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> LABEL_16<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>
            v5 <span class="token operator">^=</span> v3<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> LABEL_16<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span>
            v5 <span class="token operator">=</span> v3<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> LABEL_16<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span>
            v2<span class="token punctuation">[</span>v3<span class="token punctuation">]</span> <span class="token operator">=</span> v5<span class="token punctuation">;</span>
            <span class="token comment">// printf("%c: %d \n", v5, v3);</span>
            <span class="token keyword">goto</span> LABEL_16<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">8</span><span class="token operator">:</span>
            v5 <span class="token operator">=</span> v2<span class="token punctuation">[</span>v3<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> LABEL_16<span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
        LABEL_16<span class="token operator">:</span>
            i <span class="token operator">-=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>n <span class="token operator">&lt;</span> <span class="token number">25</span><span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c"</span><span class="token punctuation">,</span> v2<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Middle-Super-Mario-Code"><a href="#Middle-Super-Mario-Code" class="headerlink" title="[Middle] Super Mario Code"></a>[Middle] Super Mario Code</h2><p>搜索理解SMC是指Self Modifying Code，即自修改代码。打开ida发现main函数部分是一堆无法识别的数据：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20220930122415012.png" alt="image-20220930122415012"></p>
<p>查看SMC函数和TEA函数发现这是在程序运行过程中动态修改程序指令，于是用ida的linux动调，在服务器打开一个linux server，然后在main函数运行的第一步下断点：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20220930122654023.png" alt="image-20220930122654023"></p>
<p>一路跳步直到main那一段全部变成汇编：</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">main db 0F3h, 0Fh                       ; DATA XREF: _start+21↑o
.text:000055FBE232836E                                         ; SMC(void)+C↑o
.text:000055FBE232836E db 0F3h
.text:000055FBE232836E main endp
.text:000055FBE232836E
.text:000055FBE232836E ; ---------------------------------------------------------------------------
.text:000055FBE2328370 db  1Eh
.text:000055FBE2328371 db 0FAh
.text:000055FBE2328372 ; ---------------------------------------------------------------------------
.text:000055FBE2328372 push    rbp
.text:000055FBE2328373 mov     rbp, rsp
.text:000055FBE2328376 sub     rsp, 90h
.text:000055FBE232837D mov     [rbp-84h], edi
.text:000055FBE2328383 mov     [rbp-90h], rsi
.text:000055FBE232838A mov     qword ptr [rbp-50h], 0
.text:000055FBE2328392 mov     qword ptr [rbp-48h], 0
.text:000055FBE232839A mov     qword ptr [rbp-40h], 0
.text:000055FBE23283A2 mov     qword ptr [rbp-38h], 0
.text:000055FBE23283AA mov     qword ptr [rbp-30h], 0
.text:000055FBE23283B2 mov     qword ptr [rbp-28h], 0
.text:000055FBE23283BA mov     qword ptr [rbp-20h], 0
.text:000055FBE23283C2 mov     qword ptr [rbp-18h], 0
.text:000055FBE23283CA lea     rdi, aPleaseInputYou            ; &quot;Please Input Your Flag:&quot;
.text:000055FBE23283D1 call    _puts
.text:000055FBE23283D6 mov     rax, 200E103830302D20h
.text:000055FBE23283E0 mov     rdx, 3A3072261C30721Ch
.text:000055FBE23283EA mov     [rbp-80h], rax
.text:000055FBE23283EE mov     [rbp-78h], rdx
.text:000055FBE23283F2 mov     rax, 372231242D732062h
.text:000055FBE23283FC mov     rdx, 302D2C7237222F36h
.text:000055FBE2328406 mov     [rbp-70h], rax
.text:000055FBE232840A mov     [rbp-68h], rdx
.text:000055FBE232840E mov     word ptr [rbp-60h], 3E62h
.text:000055FBE2328414 mov     byte ptr [rbp-5Eh], 0
.text:000055FBE2328418 lea     rax, [rbp-50h]
.text:000055FBE232841C mov     edx, 22h ; &#39;&quot;&#39;
.text:000055FBE2328421 mov     rsi, rax
.text:000055FBE2328424 mov     edi, 0
.text:000055FBE2328429 call    _read
.text:000055FBE232842E mov     dword ptr [rbp-4], 0
.text:000055FBE2328435
.text:000055FBE2328435 loc_55FBE2328435:                       ; CODE XREF: .text:000055FBE2328457↓j
.text:000055FBE2328435 cmp     dword ptr [rbp-4], 21h ; &#39;!&#39;
.text:000055FBE2328439 jg      short loc_55FBE2328459
.text:000055FBE232843B mov     eax, [rbp-4]
.text:000055FBE232843E cdqe
.text:000055FBE2328440 movzx   eax, byte ptr [rbp+rax-50h]
.text:000055FBE2328445 xor     eax, 43h
.text:000055FBE2328448 mov     edx, eax
.text:000055FBE232844A mov     eax, [rbp-4]
.text:000055FBE232844D cdqe
.text:000055FBE232844F mov     [rbp+rax-50h], dl
.text:000055FBE2328453 add     dword ptr [rbp-4], 1
.text:000055FBE2328457 jmp     short loc_55FBE2328435
.text:000055FBE2328459 ; ---------------------------------------------------------------------------
.text:000055FBE2328459
.text:000055FBE2328459 loc_55FBE2328459:                       ; CODE XREF: .text:000055FBE2328439↑j
.text:000055FBE2328459 mov     dword ptr [rbp-8], 0
.text:000055FBE2328460
.text:000055FBE2328460 loc_55FBE2328460:                       ; CODE XREF: .text:000055FBE2328495↓j
.text:000055FBE2328460 cmp     dword ptr [rbp-8], 21h ; &#39;!&#39;
.text:000055FBE2328464 jg      short loc_55FBE2328497
.text:000055FBE2328466 mov     eax, [rbp-8]
.text:000055FBE2328469 cdqe
.text:000055FBE232846B movzx   edx, byte ptr [rbp+rax-50h]
.text:000055FBE2328470 mov     eax, [rbp-8]
.text:000055FBE2328473 cdqe
.text:000055FBE2328475 movzx   eax, byte ptr [rbp+rax-80h]
.text:000055FBE232847A cmp     dl, al
.text:000055FBE232847C jz      short loc_55FBE2328491
.text:000055FBE232847E lea     rdi, aWrong                     ; &quot;Wrong!&quot;
.text:000055FBE2328485 call    _puts
.text:000055FBE232848A mov     eax, 0
.text:000055FBE232848F jmp     short locret_55FBE23284A8
.text:000055FBE2328491 ; ---------------------------------------------------------------------------
.text:000055FBE2328491
.text:000055FBE2328491 loc_55FBE2328491:                       ; CODE XREF: .text:000055FBE232847C↑j
.text:000055FBE2328491 add     dword ptr [rbp-8], 1
.text:000055FBE2328495 jmp     short loc_55FBE2328460
.text:000055FBE2328497 ; ---------------------------------------------------------------------------
.text:000055FBE2328497
.text:000055FBE2328497 loc_55FBE2328497:                       ; CODE XREF: .text:000055FBE2328464↑j
.text:000055FBE2328497 lea     rdi, aCorrect                   ; &quot;Correct!&quot;
.text:000055FBE232849E call    _puts
.text:000055FBE232849E ; ---------------------------------------------------------------------------
.text:000055FBE23284A3 db 0B8h
.text:000055FBE23284A4 db    0
.text:000055FBE23284A5 db    0
.text:000055FBE23284A6 word_55FBE23284A6 dw 0                  ; DATA XREF: SMC(void)+17↑o
.text:000055FBE23284A8 ; ---------------------------------------------------------------------------
.text:000055FBE23284A8
.text:000055FBE23284A8 locret_55FBE23284A8:                    ; CODE XREF: .text:000055FBE232848F↑j
.text:000055FBE23284A8 leave
.text:000055FBE23284A9 retn<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>选中main这一坨按f5，变成伪代码：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">sub_55FBE2328372</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  __int64 v1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+10h] [rbp-80h]</span>
  <span class="token keyword">char</span> v2<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+20h] [rbp-70h] BYREF</span>
  __int64 buf<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+40h] [rbp-50h] BYREF</span>
  <span class="token keyword">int</span> j<span class="token punctuation">;</span> <span class="token comment">// [rsp+88h] [rbp-8h]</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [rsp+8Ch] [rbp-4h]</span>

  buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  buf<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  buf<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Please Input Your Flag:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x200E103830302D20LL</span><span class="token punctuation">;</span>
  v1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x3A3072261C30721CLL</span><span class="token punctuation">;</span>
  <span class="token function">strcpy</span><span class="token punctuation">(</span>v2<span class="token punctuation">,</span> <span class="token string">"b s-$1\"76/\"7r,-0b>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0x22uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">33</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span>buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">^=</span> <span class="token number">0x43u</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token operator">++</span>j <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> j <span class="token operator">></span> <span class="token number">33</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Correct!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">JUMPOUT</span><span class="token punctuation">(</span><span class="token number">0x55FBE23284A3LL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span>buf <span class="token operator">+</span> j<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span>v1 <span class="token operator">+</span> j<span class="token punctuation">)</span> <span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Wrong!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0LL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>根据代码写逆向即可：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>

<span class="token keyword">long</span> v1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> v2<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">long</span> buf<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
    buf<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
    
    v1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x200E103830302D20LL</span><span class="token punctuation">;</span>
    v1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x3A3072261C30721CLL</span><span class="token punctuation">;</span>
    <span class="token function">strcpy</span><span class="token punctuation">(</span>v2<span class="token punctuation">,</span> <span class="token string">"b s-$1\"76/\"7r,-0b>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">33</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>v1 <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">strcat</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span> v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">33</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">^=</span> <span class="token number">0x43</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Middle-花花"><a href="#Middle-花花" class="headerlink" title="[Middle] 花花"></a>[Middle] 花花</h2><p>搜索知道花指令是放在正常指令中间混淆反编译过程的指令，不会影响程序正常运行，但是会影响ida分析指令的过程，导致很多函数无法反汇编。</p>
<p>打开ida，查看main函数，发现输入flag后经过了<code>sub_</code>函数的处理，反编译这个函数，发现出现了<code>JUMPOUT(xxxx)</code>，根据JUMPOUT的内容推测这个地址处含有花指令。</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221004000247964.png" alt="image-20221004000247964"></p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221004000300334.png" alt="image-20221004000300334"></p>
<p>发现<code>.text:00401084</code>处的<code>jnz short $+2</code>无法达到，因为其上<code>xor eax, eax</code>导致ZF为1，其下的<code>jz</code>必定执行。故将此花指令改为nop。<img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221004000409248.png" alt="image-20221004000409248"></p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221004001051569.png" alt="image-20221004001051569"></p>
<p>查看另一处花指令，此处<code>xor</code>导致jz必定执行，同时发现跳转地址比下方代码段的地址加1，说明代码段的真实开始位置是<code>.text:00401272</code>，而此地址前的一个字节被错误解析为指令导致了无法反编译，因此找到<code>.text:00401272</code>处的字节修改为90（即nop代表的字节）：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221004001153309.png" alt="image-20221004001153309"></p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221004001418695.png" alt="image-20221004001418695"></p>
<p>后面还发现下面还有一处同样的花指令，进行同样的修改即可。</p>
<p><code>Edit -&gt; Patch Program -&gt; Apply </code> patches to input file后，重新打开ida即发现这两处代码可以反编译了。复制整理后如下：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>

<span class="token keyword">char</span> <span class="token function">sub_401005</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>a2<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> result<span class="token punctuation">;</span> <span class="token comment">// al</span>
  <span class="token keyword">char</span> v3<span class="token punctuation">;</span> <span class="token comment">// [esp+4Ch] [ebp-4h]</span>

  v3 <span class="token operator">=</span> <span class="token operator">*</span>a1<span class="token punctuation">;</span>
  <span class="token operator">*</span>a1 <span class="token operator">=</span> <span class="token operator">*</span>a2<span class="token punctuation">;</span>
  result <span class="token operator">=</span> v3<span class="token punctuation">;</span>
  <span class="token operator">*</span>a2 <span class="token operator">=</span> v3<span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">size_t</span> <span class="token function">step1</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>a1<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token class-name">size_t</span> result<span class="token punctuation">;</span> <span class="token comment">// eax</span>
  <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment">// [esp+4Ch] [ebp-54h]</span>
  <span class="token keyword">int</span> j<span class="token punctuation">;</span> <span class="token comment">// [esp+50h] [ebp-50h]</span>
  <span class="token keyword">signed</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [esp+54h] [ebp-4Ch]</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> k<span class="token punctuation">;</span> <span class="token comment">// [esp+54h] [ebp-4Ch]</span>
  <span class="token keyword">int</span> v6<span class="token punctuation">;</span> <span class="token comment">// [esp+58h] [ebp-48h]</span>
  <span class="token keyword">char</span> Str<span class="token punctuation">[</span><span class="token number">68</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+5Ch] [ebp-44h] BYREF</span>

  <span class="token function">strcpy</span><span class="token punctuation">(</span>Str<span class="token punctuation">,</span> <span class="token string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v6 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>Str<span class="token punctuation">)</span><span class="token punctuation">;</span>     
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">strlen</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v6 <span class="token operator">+</span> v6 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v6 <span class="token operator">+</span> v6 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> v6<span class="token punctuation">;</span> <span class="token operator">++</span>j <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> Str<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span>
        v2 <span class="token operator">=</span> j<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> Str<span class="token punctuation">[</span><span class="token punctuation">(</span>v2 <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">*</span> i<span class="token punctuation">)</span> <span class="token operator">%</span> v6<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token operator">++</span>k <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    result <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> k <span class="token operator">>=</span> result <span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> a1<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">123</span> <span class="token punctuation">)</span>
      a1<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">47</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> a1<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">125</span> <span class="token punctuation">)</span>
      a1<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">43</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">char</span> <span class="token operator">*</span> <span class="token function">step2</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>Str<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token class-name">size_t</span> v1<span class="token punctuation">;</span> <span class="token comment">// eax</span>
  <span class="token class-name">size_t</span> v2<span class="token punctuation">;</span> <span class="token comment">// eax</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>result<span class="token punctuation">;</span> <span class="token comment">// eax</span>
  <span class="token class-name">size_t</span> i<span class="token punctuation">;</span> <span class="token comment">// [esp+4Ch] [ebp-4h]</span>
  <span class="token class-name">size_t</span> j<span class="token punctuation">;</span> <span class="token comment">// [esp+4Ch] [ebp-4h]</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">strlen</span><span class="token punctuation">(</span>Str<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    v1 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>Str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sub_401005</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Str<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>Str<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">%</span> v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token function">strlen</span><span class="token punctuation">(</span>Str<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>j <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    v2 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>Str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sub_401005</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Str<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>Str<span class="token punctuation">[</span><span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">%</span> v2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  Str<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">61</span><span class="token punctuation">;</span>
  result <span class="token operator">=</span> Str<span class="token punctuation">;</span>
  Str<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">61</span><span class="token punctuation">;</span>
  Str<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">char</span> str<span class="token punctuation">[</span><span class="token number">33</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"your input str"</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> <span class="token operator">*</span>result <span class="token operator">=</span> <span class="token string">"Jew/PwcnwJJsCMMM1qyPZE5iHshiOF=="</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">step1</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">step2</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s \n"</span><span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>根据代码写出逆向代码：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>

<span class="token keyword">char</span> <span class="token function">sub_401005</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>a1<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>a2<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> result<span class="token punctuation">;</span> <span class="token comment">// al</span>
  <span class="token keyword">char</span> v3<span class="token punctuation">;</span> <span class="token comment">// [esp+4Ch] [ebp-4h]</span>

  v3 <span class="token operator">=</span> <span class="token operator">*</span>a1<span class="token punctuation">;</span>
  <span class="token operator">*</span>a1 <span class="token operator">=</span> <span class="token operator">*</span>a2<span class="token punctuation">;</span>
  result <span class="token operator">=</span> v3<span class="token punctuation">;</span>
  <span class="token operator">*</span>a2 <span class="token operator">=</span> v3<span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token class-name">size_t</span> <span class="token function">reverse</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>a1<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token class-name">size_t</span> result<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> k<span class="token punctuation">;</span>
  <span class="token keyword">char</span> Str<span class="token punctuation">[</span><span class="token number">68</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">signed</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span>
  <span class="token keyword">int</span> j<span class="token punctuation">;</span>
  <span class="token keyword">int</span> v6<span class="token punctuation">;</span>
  <span class="token keyword">int</span> v2<span class="token punctuation">;</span>
  
  <span class="token function">strcpy</span><span class="token punctuation">(</span>Str<span class="token punctuation">,</span> <span class="token string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  v6 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>Str<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">strlen</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> now<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> v6<span class="token punctuation">;</span> <span class="token operator">++</span>j <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> Str<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span>
        now <span class="token operator">=</span> j<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> m <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>m <span class="token operator">&lt;</span> v6<span class="token punctuation">;</span>m <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>m <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">*</span> i<span class="token punctuation">)</span> <span class="token operator">%</span> v6 <span class="token operator">==</span> now<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        v2 <span class="token operator">=</span> m<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> Str<span class="token punctuation">[</span>v2<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token operator">++</span>k <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    result <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> k <span class="token operator">>=</span> result <span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> a1<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">47</span> <span class="token punctuation">)</span>
      a1<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> a1<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">43</span> <span class="token punctuation">)</span>
      a1<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">125</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">char</span> <span class="token operator">*</span> <span class="token function">reverse2</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>Str<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token class-name">size_t</span> v1<span class="token punctuation">;</span> <span class="token comment">// eax</span>
  <span class="token class-name">size_t</span> v2<span class="token punctuation">;</span> <span class="token comment">// eax</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>result<span class="token punctuation">;</span> <span class="token comment">// eax</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [esp+4Ch] [ebp-4h]</span>
  <span class="token keyword">int</span> j<span class="token punctuation">;</span> <span class="token comment">// [esp+4Ch] [ebp-4h]</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> j <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>Str<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">--</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    v2 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>Str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sub_401005</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Str<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>Str<span class="token punctuation">[</span><span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">%</span> v2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>Str<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    v1 <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>Str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sub_401005</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Str<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>Str<span class="token punctuation">[</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">%</span> v1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  
  result <span class="token operator">=</span> Str<span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">char</span> str1<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Jew/PwcnwJJsCMMM1qyPZE5iHshiOF"</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">reverse2</span><span class="token punctuation">(</span>str1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">reverse</span><span class="token punctuation">(</span>str1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s \n"</span><span class="token punctuation">,</span> str1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Middle-Shino-的心跳大冒险"><a href="#Middle-Shino-的心跳大冒险" class="headerlink" title="[Middle] Shino 的心跳大冒险"></a>[Middle] Shino 的心跳大冒险</h2><p>打开游戏发现了可爱的CNSS娘挡住了flag，于是想办法让她不要挡住flag即可。</p>
<p>翻了半天发现<code>YuriConfig.dat</code>文件里写的是一些布局信息，于是想到把flag输出的文字偏离cnss娘的阻挡范围。</p>
<p>把<code> YuriConfig.dat</code>文件的<code> GameMsgLayerX=&gt;0=&gt;3</code>改成<code> GameMsgLayerX=&gt;-300=&gt;3</code>即可。</p>
<h2 id="Easy-Baby-XOR"><a href="#Easy-Baby-XOR" class="headerlink" title="[Easy?] Baby XOR?"></a>[Easy?] Baby XOR?</h2><p>😭这就是全栈CTFer的世界吗😭完全不会……</p>
<p>本题含有<strong>Re，Crypto和Misc</strong>的内容。</p>
<p>文件里是一个<code>virus.exe</code>和一张<code>setu_encoded.png</code>，任务应该就是decode一下这个图片然后得到flag。</p>
<p>把exe放进ida，发现main函数主要逻辑是一个读取原<code>setu.png</code>然后对每个字节进行修改最后写入到<code>setu_encoded.png</code>里。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  _DWORD <span class="token operator">*</span>v3<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  FILE <span class="token operator">*</span>v5<span class="token punctuation">;</span> <span class="token comment">// [rsp+48h] [rbp-28h]</span>
  FILE <span class="token operator">*</span>Stream<span class="token punctuation">;</span> <span class="token comment">// [rsp+58h] [rbp-18h]</span>
  <span class="token keyword">int</span> j<span class="token punctuation">;</span> <span class="token comment">// [rsp+60h] [rbp-10h]</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [rsp+6Ch] [rbp-4h]</span>

  <span class="token function">_main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Stream <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"setu.png"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fseek</span><span class="token punctuation">(</span>Stream<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fread</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0xD1EFEu</span>i64<span class="token punctuation">,</span> <span class="token number">1u</span>i64<span class="token punctuation">,</span> Stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fclose</span><span class="token punctuation">(</span>Stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> Stream <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    v3 <span class="token operator">=</span> <span class="token function">_cxa_allocate_exception</span><span class="token punctuation">(</span><span class="token number">4u</span>i64<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>v3 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">_cxa_throw</span><span class="token punctuation">(</span>v3<span class="token punctuation">,</span> refptr__ZTIi<span class="token punctuation">,</span> <span class="token number">0</span>i64<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">859901</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
    buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^=</span> <span class="token number">0x55u</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> <span class="token number">859901</span><span class="token punctuation">;</span> <span class="token operator">++</span>j <span class="token punctuation">)</span>
    buf<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">17</span><span class="token punctuation">;</span>
  v5 <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"setu_encoded.png"</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fwrite</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0xD1EFEu</span>i64<span class="token punctuation">,</span> <span class="token number">1u</span>i64<span class="token punctuation">,</span> v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fclose</span><span class="token punctuation">(</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>发现如果读到了<code>setu.png</code>就会抛出一个异常然后进行某些处理，为了找到相应的处理函数，需要进行异常处理的逆向。</p>
<p>打开ida的流程图，查看main函数的控制流：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221014183429292.png" alt="image-20221014183429292"></p>
<p>发现catch到这个异常后转到了<code>loc_401C6A</code>这个位置：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221014184146997.png" alt="image-20221014184146997"></p>
<p>可以跳过异常处理块直接跳转调用这部分代码，在catch处pathc program，将catch操作改为直接跳转至<code>loc_401C6A</code>：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221014184515396.png" alt="image-20221014184515396"></p>
<p>重新反编译生成伪代码，可以看到此时的完整加密流程：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> __cdecl <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>envp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment">// ebx</span>
  <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment">// esi</span>
  <span class="token keyword">unsigned</span> __int8 v6<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+30h] [rbp-40h] BYREF</span>
  <span class="token keyword">unsigned</span> __int8 v7<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+40h] [rbp-30h] BYREF</span>
  FILE <span class="token operator">*</span>v8<span class="token punctuation">;</span> <span class="token comment">// [rsp+48h] [rbp-28h]</span>
  FILE <span class="token operator">*</span>v9<span class="token punctuation">;</span> <span class="token comment">// [rsp+50h] [rbp-20h]</span>
  FILE <span class="token operator">*</span>Stream<span class="token punctuation">;</span> <span class="token comment">// [rsp+58h] [rbp-18h]</span>
  <span class="token keyword">int</span> j<span class="token punctuation">;</span> <span class="token comment">// [rsp+60h] [rbp-10h]</span>
  <span class="token keyword">int</span> k<span class="token punctuation">;</span> <span class="token comment">// [rsp+64h] [rbp-Ch]</span>
  <span class="token keyword">int</span> v13<span class="token punctuation">;</span> <span class="token comment">// [rsp+68h] [rbp-8h]</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [rsp+6Ch] [rbp-4h]</span>

  <span class="token function">_main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Stream <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"setu.png"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fseek</span><span class="token punctuation">(</span>Stream<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fread</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0xD1EFEu</span>i64<span class="token punctuation">,</span> <span class="token number">1u</span>i64<span class="token punctuation">,</span> Stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fclose</span><span class="token punctuation">(</span>Stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>Stream <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">859901</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
      buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^=</span> <span class="token number">0x55u</span><span class="token punctuation">;</span>
LABEL_5<span class="token operator">:</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> <span class="token number">859901</span><span class="token punctuation">;</span> <span class="token operator">++</span>j <span class="token punctuation">)</span>
      buf<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">17</span><span class="token punctuation">;</span>
    v8 <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"setu_encoded.png"</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fwrite</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0xD1EFEu</span>i64<span class="token punctuation">,</span> <span class="token number">1u</span>i64<span class="token punctuation">,</span> v8<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>v8<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> v13 <span class="token operator">&lt;=</span> <span class="token number">3</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v7<span class="token punctuation">[</span>v13<span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">0x50u</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Wrong key."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      v3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
LABEL_20<span class="token operator">:</span>
      v5 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> LABEL_21<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token operator">++</span>v13<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">_Encrypt</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> v7<span class="token punctuation">,</span> <span class="token number">859902</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fscanf</span><span class="token punctuation">(</span>v9<span class="token punctuation">,</span> <span class="token string">"%d%d%d%d"</span><span class="token punctuation">,</span> v6<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v6<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v6<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>v6<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span>k <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> v6<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">></span> <span class="token number">0x50u</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Wrong key."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      v3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> LABEL_20<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">_Encrypt</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> v6<span class="token punctuation">,</span> <span class="token number">859902</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fclose</span><span class="token punctuation">(</span>v9<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v5 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
LABEL_21<span class="token operator">:</span>
  <span class="token function">_cxa_end_catch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v5 <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>
    <span class="token keyword">goto</span> LABEL_5<span class="token punctuation">;</span>
  <span class="token keyword">return</span> v3<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>发现利用了某两个key来进行了两次<code>_Encrypt</code>操作，点进<code>_Encrypt</code>函数并整理得到：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">long</span> <span class="token function">initST</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>k<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [rsp+Ch] [rbp-4h]</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">255</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    s<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
    k<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> key<span class="token punctuation">[</span>i <span class="token operator">%</span> len<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token number">0L</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">long</span> <span class="token function">initS</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>a1<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>a2<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+7h] [rbp-9h]</span>
  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-8h]</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [rsp+Ch] [rbp-4h]</span>

  v4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">255</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    v4 <span class="token operator">=</span> <span class="token punctuation">(</span>a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> v4 <span class="token operator">+</span> a2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">;</span>
    v3 <span class="token operator">=</span> a1<span class="token punctuation">[</span>v4<span class="token punctuation">]</span><span class="token punctuation">;</span>
    a1<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token operator">=</span> a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> v3<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token number">0L</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">long</span> <span class="token function">initK</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>a1<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">int</span> a3<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+13h] [rbp-Dh]</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [rsp+14h] [rbp-Ch]</span>
  <span class="token keyword">int</span> v6<span class="token punctuation">;</span> <span class="token comment">// [rsp+18h] [rbp-8h]</span>
  <span class="token keyword">int</span> v7<span class="token punctuation">;</span> <span class="token comment">// [rsp+1Ch] [rbp-4h]</span>

  v7 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  v6 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> a3<span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    v7 <span class="token operator">=</span> <span class="token punctuation">(</span>v7 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">;</span>
    v6 <span class="token operator">=</span> <span class="token punctuation">(</span>v6 <span class="token operator">+</span> a1<span class="token punctuation">[</span>v7<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">256</span><span class="token punctuation">;</span>
    v4 <span class="token operator">=</span> a1<span class="token punctuation">[</span>v6<span class="token punctuation">]</span><span class="token punctuation">;</span>
    a1<span class="token punctuation">[</span>v6<span class="token punctuation">]</span> <span class="token operator">=</span> a1<span class="token punctuation">[</span>v7<span class="token punctuation">]</span><span class="token punctuation">;</span>
    a1<span class="token punctuation">[</span>v7<span class="token punctuation">]</span> <span class="token operator">=</span> v4<span class="token punctuation">;</span>
    a2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> a1<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1<span class="token punctuation">[</span>v7<span class="token punctuation">]</span> <span class="token operator">+</span> a1<span class="token punctuation">[</span>v6<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token number">0L</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">long</span> <span class="token function">Enc</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>a1<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>a2<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>a3<span class="token punctuation">,</span> <span class="token keyword">int</span> a4<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [rsp+Ch] [rbp-4h]</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> a4<span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
    a3<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> a2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0L</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">long</span> <span class="token function">_Encrypt</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf_arg<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>key_arg<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>v3<span class="token punctuation">;</span> <span class="token comment">// rdx</span>
  <span class="token keyword">long</span> result<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  <span class="token keyword">long</span> v5<span class="token punctuation">;</span> <span class="token comment">// [rsp+0h] [rbp-80h] BYREF</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+20h] [rbp-60h] BYREF</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> k<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+120h] [rbp+A0h] BYREF</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> key<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+220h] [rbp+1A0h] BYREF</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> v9<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+320h] [rbp+2A0h] BYREF</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> v10<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+420h] [rbp+3A0h] BYREF</span>
  <span class="token keyword">char</span> v11<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+520h] [rbp+4A0h] BYREF</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [rsp+62Ch] [rbp+5ACh]</span>

  <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v5 <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0x100uL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>v10<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>v10<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memset</span><span class="token punctuation">(</span>v11<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>v11<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> key_arg<span class="token punctuation">,</span> <span class="token number">8uL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">memcpy</span><span class="token punctuation">(</span>v9<span class="token punctuation">,</span> buf_arg<span class="token punctuation">,</span> <span class="token number">8uL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">initST</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> k<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment">// RC4</span>
  <span class="token function">initS</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>                                  <span class="token comment">// RC4</span>
  <span class="token function">initK</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    

  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">256</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>result <span class="token operator">>=</span> len <span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>v10<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>v10<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>v9<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buf_arg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>v9<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Enc</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> v9<span class="token punctuation">,</span> v10<span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    v3 <span class="token operator">=</span> <span class="token operator">&amp;</span>buf_arg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span>v3 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span>v10<span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span>v3 <span class="token operator">+</span> <span class="token number">31</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v10<span class="token punctuation">[</span><span class="token number">248</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v3 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFFFFFFFFF8uL</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v10 <span class="token operator">-</span> <span class="token operator">&amp;</span>v3<span class="token punctuation">[</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v3 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFFFFFFFFF8uL</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token number">8L</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>v3 <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>v3 <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFF8</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFFFFFFF8</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>查阅<code>CTF Wiki</code>可知这是一个标准的RC4加密，RC4是一个对称的流加密算法，加密解密都使用同样的方式，这意味着两次用同样的key进行加密后得到的结果串是不变的。有这个性质就可以不用专门写decrypt代码啦（懒）！</p>
<p>要解密图片，就需要得到加密时的key，而题中所用的key是一个含4个元素的数组，每个元素的范围都是0~79。两个不同的key，要想纯暴力破解key的复杂度为O(n^2)（运行时间可能会有点过于离谱）。</p>
<p>再次查阅<code>CTF Wiki</code>可以知道对于两重加密可以使用<strong>Meet in the Middle（中间相遇攻击）</strong>，即知道一对相应的输入和输出时，可以根据其输入P和输出C，分别遍历key，对输入P加密一次，其结果排序并保存。然后再遍历key，对输出C加密一次，并在P加密的结果中查找是否有与当前结果相同的，若找到，则可认为其对应的key1、key2为正确的key。</p>
<p>分析可知，此方法只需要分别进行两次遍历单个key的操作（O(n)），并包含一个查找和排序的操作（O(nlogn)），将原先整体O(n^2)的复杂度降低到了O(nlogn)，这下可以在去世之前跑出来了。</p>
<p>于是写出破解key的函数：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> key<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    map<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">></span> res<span class="token punctuation">;</span><span class="token comment">//第一次遍历加密的结果</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> key1<span class="token punctuation">[</span><span class="token number">4000</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">//储存key1的所有结果</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> key2<span class="token punctuation">[</span><span class="token number">4000</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">//储存key2的所有结果</span>
    <span class="token keyword">int</span> keyp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//key储存数组的指针</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      encoded<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-=</span> <span class="token number">0x11</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">80</span><span class="token punctuation">;</span> i <span class="token operator">++</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      key<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>j <span class="token operator">&lt;</span> <span class="token number">80</span><span class="token punctuation">;</span>j <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        key<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> j<span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d,%d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>k <span class="token operator">&lt;</span> <span class="token number">80</span><span class="token punctuation">;</span>k <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          key<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> k<span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> l <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>l <span class="token operator">&lt;</span> <span class="token number">80</span><span class="token punctuation">;</span>l <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">memcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> origin<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            key<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> l<span class="token punctuation">;</span>
            <span class="token function">_Encrypt</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> k0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">memcpy</span><span class="token punctuation">(</span>k0<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            string <span class="token function">s</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            res<span class="token punctuation">[</span>s<span class="token punctuation">]</span> <span class="token operator">=</span> k0<span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">80</span><span class="token punctuation">;</span> i <span class="token operator">++</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      key<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>j <span class="token operator">&lt;</span> <span class="token number">80</span><span class="token punctuation">;</span>j <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        key<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> j<span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d,%d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>k <span class="token operator">&lt;</span> <span class="token number">80</span><span class="token punctuation">;</span>k <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          key<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> k<span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> l <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>l <span class="token operator">&lt;</span> <span class="token number">80</span><span class="token punctuation">;</span>l <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">memcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> encoded<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            key<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> l<span class="token punctuation">;</span>
            <span class="token function">_Encrypt</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            map<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">></span><span class="token operator">::</span>iterator key0 <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>key0 <span class="token operator">!=</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n--------------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"find key1: \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d,"</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span>key0<span class="token operator">-></span>first<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                key1<span class="token punctuation">[</span>keyp <span class="token operator">+</span> i<span class="token punctuation">]</span> <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span>key0<span class="token operator">-></span>first<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
              <span class="token punctuation">&#125;</span>
              <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nfind key2:\n%d,%d,%d,%d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">,</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>
              key2<span class="token punctuation">[</span>keyp<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
              key2<span class="token punctuation">[</span>keyp <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> j<span class="token punctuation">;</span>
              key2<span class="token punctuation">[</span>keyp <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> k<span class="token punctuation">;</span>
              key2<span class="token punctuation">[</span>keyp <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> l<span class="token punctuation">;</span>
              keyp <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">;</span>
              <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\nnow:%d --------------------\n"</span><span class="token punctuation">,</span> keyp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> 
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">+=</span><span class="token number">4</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n%d-key1:"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d,"</span><span class="token punctuation">,</span> key1<span class="token punctuation">[</span>i <span class="token operator">+</span> j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"/n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n%d-key2:"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d,"</span><span class="token punctuation">,</span> key2<span class="token punctuation">[</span>i <span class="token operator">+</span> j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"/n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用了c++的map类型来储存第一次加密的所有结果，其自实现的一个排序的map表，可以大大优化查找效率。</p>
<p>由于加密前的图片是<strong>PNG</strong>格式的，所以可以根据PNG的固定格式所需包含的字节来作为输入字节，其内容如下：</p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token list punctuation">-</span> （固定）八个字节89 50 4E 47 0D 0A 1A 0A为png的文件头
<span class="token list punctuation">-</span> （固定）四个字节00 00 00 0D（即为十进制的13）代表数据块的长度为13
<span class="token list punctuation">-</span> （固定）四个字节49 48 44 52（即为ASCII码的IHDR）是文件头数据块的标示（IDCH）
<span class="token list punctuation">-</span> （可变）13位数据块（IHDR)
  <span class="token list punctuation">-</span> 前四个字节代表该图片的宽
  <span class="token list punctuation">-</span> 后四个字节代表该图片的高
  <span class="token list punctuation">-</span> 后五个字节依次为：
    Bit depth、ColorType、Compression method、Filter method、Interlace method
<span class="token list punctuation">-</span> （可变）剩余四字节为该png的CRC检验码，由从IDCH到IHDR的十七位字节进行crc计算得到。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>于是可以利用固定的字节<code>89 50 4E 47 0D 0A 1A 0A 00 00 00 0D 49 48 44 52</code>来作为输入，<code>setu_encoded.png</code>的前16个字节作为输出，最后跑出key来，也可以少用字节几个减少内存占用。</p>
<p>最后代入key解密出原图片，flag就在图里：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    Stream <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"setu_encoded.png"</span><span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fseek</span><span class="token punctuation">(</span>Stream<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fread</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0xD1EFEuL</span><span class="token punctuation">,</span> <span class="token number">1uL</span><span class="token punctuation">,</span> Stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>Stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> key1<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">35</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">34</span><span class="token punctuation">,</span><span class="token number">69</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> key2<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">63</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;=</span> <span class="token number">859901</span><span class="token punctuation">;</span> <span class="token operator">++</span>k <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        buf<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">-=</span> <span class="token number">17</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">_Encrypt</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> key2<span class="token punctuation">,</span> <span class="token number">859902</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_Encrypt</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> key1<span class="token punctuation">,</span> <span class="token number">859902</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    v5 <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string">"setu.png"</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fwrite</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0xD1EFEuL</span><span class="token punctuation">,</span> <span class="token number">1uL</span><span class="token punctuation">,</span> v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Hard-Brainfuck"><a href="#Hard-Brainfuck" class="headerlink" title="[Hard] Brainfuck++"></a>[Hard] Brainfuck++</h2><p>太顶了这道题，果然还是我太菜了😭做了好久~</p>
<p>开局执行一下exe，效果如下：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221010113758032.png" alt="image-20221010113758032"></p>
<p>拖入ida，搜索字符串，没有搜到<code>Welcome to the brainfuck++! Plz input the flag</code>，很奇怪，于是在x64dbg里动调，发现程序显示出<code>No hacking!</code>：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221010114026576.png" alt="image-20221010114026576"></p>
<p>应该是程序里有反调试，于是搜索这个字符串，在<code>BfRuntime.dll</code>里找到，定位到对应的引用位置的函数：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">sub_62881550</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  HANDLE v0<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  BOOL pbDebuggerPresent<span class="token punctuation">;</span> <span class="token comment">// [rsp+24h] [rbp-Ch] BYREF</span>
  HMODULE v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+28h] [rbp-8h]</span>

  v3 <span class="token operator">=</span> <span class="token function">GetModuleHandleA</span><span class="token punctuation">(</span><span class="token string">"BfRuntime.dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">IsDebuggerPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">||</span> <span class="token punctuation">(</span>v0 <span class="token operator">=</span> <span class="token function">GetCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">CheckRemoteDebuggerPresent</span><span class="token punctuation">(</span>v0<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pbDebuggerPresent<span class="token punctuation">)</span><span class="token punctuation">,</span> pbDebuggerPresent<span class="token punctuation">)</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"No hacking!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>v3 <span class="token operator">+</span> <span class="token number">5067</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">1</span>i64<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其使用了<code>IsDebuggerPresent</code>和<code>CheckRemoteDebuggerPresent</code>来判断是否正在调试，在CTF-Wiki里查询相关内容知道<code>IsDebuggerPresent</code>这个函数只是单纯地返回了<code>BeingDebugged</code>标志的值，其汇编如下：</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">push 60h
pop rsi
gs:lodsq ;Process Environment Block
cmp b [rax+2], 0 ;check BeingDebugged
jne being_debugged<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而<code>CheckRemoteDebuggerPresent</code>可以直接修改<code>isDebuggerPresent</code>的值或修改跳转条件来绕过，所以只需要在调试器里打开系统断点，修改<code>BeingDebugged</code>的值即可。</p>
<p>但是我想了想，发现这个简单的if判断可以直接把对应处的<code>jnz</code>指令改为<code>jz</code>即可（不过这样会导致非调试状态下无法正常运行）：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221010114953164.png" alt="image-20221010114953164"></p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221010114740829.png" alt="image-20221010114740829"></p>
<p>接下来开始调试，首先在字符串里发现了<code>Wrong</code>，于是跳到引用位置，下个断点，F9开始运行并调试：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221010172219134.png" alt="image-20221010172219134"></p>
<p>一路跳到<code>Wrong</code>的位置，往前回溯一下，发现过程中一个可疑的位置：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221010184047376.png" alt="image-20221010184047376"></p>
<p>找到其函数函数：<code>sub_401624</code>和<code>sub_401550</code>：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 __fastcall <span class="token function">sub_401624</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  __int64 result<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  <span class="token keyword">char</span> Buf1<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+20h] [rbp-40h] BYREF</span>
  _DWORD <span class="token operator">*</span>v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+48h] [rbp-18h]</span>
  __int64 v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+50h] [rbp-10h]</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [rsp+5Ch] [rbp-4h]</span>

  v4 <span class="token operator">=</span> a1 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
  v3 <span class="token operator">=</span> <span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">-</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">53</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">67</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">23</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">107</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">96</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">96</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">50</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">26</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">99</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">80</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">62</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">46</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">111</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">19</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">85</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">21</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">117</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">61</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">118</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">25</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">27</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">26</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">116</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">27</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">103</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">126</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">37</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">11</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">63</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
    <span class="token function">sub_401550</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">8</span>i64 <span class="token operator">*</span> i <span class="token operator">+</span> v4<span class="token punctuation">)</span><span class="token punctuation">,</span> v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">memcmp</span><span class="token punctuation">(</span>Buf1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>a1 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x20u</span>i64<span class="token punctuation">)</span> <span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token number">4</span>i64<span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    result <span class="token operator">=</span> <span class="token number">3</span>i64<span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c">_DWORD <span class="token operator">*</span>__fastcall <span class="token function">sub_401550</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>a1<span class="token punctuation">,</span> _DWORD <span class="token operator">*</span>a2<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  _DWORD <span class="token operator">*</span>result<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  <span class="token keyword">unsigned</span> __int64 i<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-18h]</span>
  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+14h] [rbp-Ch]</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment">// [rsp+18h] [rbp-8h]</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v6<span class="token punctuation">;</span> <span class="token comment">// [rsp+1Ch] [rbp-4h]</span>

  v6 <span class="token operator">=</span> <span class="token operator">*</span>a1<span class="token punctuation">;</span>
  v5 <span class="token operator">=</span> a1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  v4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span>i64<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">0x1F</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    v4 <span class="token operator">-=</span> <span class="token number">1640531527</span><span class="token punctuation">;</span>
    v6 <span class="token operator">+=</span> <span class="token punctuation">(</span>v5 <span class="token operator">+</span> v4<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token operator">*</span>a2 <span class="token operator">+</span> <span class="token number">16</span> <span class="token operator">*</span> v5<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>v5 <span class="token operator">>></span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">+</span> a2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    v5 <span class="token operator">+=</span> <span class="token punctuation">(</span>v6 <span class="token operator">+</span> v4<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>a2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">16</span> <span class="token operator">*</span> v6<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>v6 <span class="token operator">>></span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">+</span> a2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token operator">*</span>a1 <span class="token operator">=</span> v6<span class="token punctuation">;</span>
  result <span class="token operator">=</span> a1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  a1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> v5<span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>感觉有点像对应的判断函数，于是去找其他地方。</p>
<p>根据题目搜了搜Brainfuck，发现这是个极小化的计算机语言，只有8个符号，但是功能很完备。</p>
<p>这是原生的brainfuck：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221010110732877.png" alt="image-20221010110732877"></p>
<p>于是ida打开<code>brainfuck++.exe</code>发现main函数里就有brainfuck：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221010110955837.png" alt="image-20221010110955837"></p>
<p>点击查看完整内容：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221010112008876.png" alt="image-20221010112008876"></p>
<p>发现有<code>!</code>，猜测可能是自实现了一个brainfuck解释器，于是查看<code>main</code>函数，其中传入这段brainfuck并调用了<code>sub_401C5D</code>函数：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 __fastcall <span class="token function">sub_401C5D</span><span class="token punctuation">(</span>__int64 a1<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment">// [rsp+2Ch] [rbp-4h]</span>

  v2 <span class="token operator">=</span> <span class="token function">sub_401734</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v2 <span class="token punctuation">)</span>
    v2 <span class="token operator">=</span> <span class="token function">sub_401A0A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v2 <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Error!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> v2 <span class="token operator">==</span> <span class="token number">3</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Wrong!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"Congratulation!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> v2<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>据此推测这个函数就是完整输入并判断flag的流程，而<code>sub_401734</code>和<code>sub_401A0A</code>函数是重点。</p>
<p>查看<code>sub_401734</code>发现一个switch判断，且判断条件包含了brainfuck的所有字符以及<code>!</code>和<code>^</code>，但是前面的brainfuck段里没有发现<code>^</code>，推测可能在运行时修改了这段代码，不过可以确定的是：<code>sub_401734</code>是这个brianfuck++解释器的一部分，将brainfuck符号转化为数字指令：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 __fastcall <span class="token function">sub_401734</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>a1<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment">// eax</span>
  <span class="token keyword">unsigned</span> __int16 v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+26h] [rbp-5Ah]</span>
  <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+28h] [rbp-58h]</span>
  <span class="token keyword">unsigned</span> __int16 v5<span class="token punctuation">;</span> <span class="token comment">// [rsp+2Ch] [rbp-54h]</span>
  <span class="token keyword">unsigned</span> __int16 v6<span class="token punctuation">;</span> <span class="token comment">// [rsp+2Eh] [rbp-52h]</span>

  v6 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  v5 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    v4 <span class="token operator">=</span> a1<span class="token punctuation">[</span>v5<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>a1<span class="token punctuation">[</span>v5<span class="token punctuation">]</span> <span class="token operator">||</span> v6 <span class="token operator">>=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span> <span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span> v4 <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">case</span> <span class="token string">'!'</span><span class="token operator">:</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_408040 <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v6<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> LABEL_18<span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'+'</span><span class="token operator">:</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_408040 <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v6<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> LABEL_18<span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">','</span><span class="token operator">:</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_408040 <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v6<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> LABEL_18<span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'-'</span><span class="token operator">:</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_408040 <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v6<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> LABEL_18<span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'.'</span><span class="token operator">:</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_408040 <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v6<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> LABEL_18<span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'&lt;'</span><span class="token operator">:</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_408040 <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v6<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> LABEL_18<span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'>'</span><span class="token operator">:</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_408040 <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v6<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> LABEL_18<span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'['</span><span class="token operator">:</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_408040 <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v6<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> dword_40C440 <span class="token operator">==</span> <span class="token number">512</span> <span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token number">1</span>i64<span class="token punctuation">;</span>
        v2 <span class="token operator">=</span> dword_40C440<span class="token operator">++</span><span class="token punctuation">;</span>
        word_40C040<span class="token punctuation">[</span>v2<span class="token punctuation">]</span> <span class="token operator">=</span> v6<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> LABEL_18<span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">']'</span><span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>dword_40C440 <span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token number">1</span>i64<span class="token punctuation">;</span>
        v3 <span class="token operator">=</span> word_40C040<span class="token punctuation">[</span><span class="token operator">--</span>dword_40C440<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_408040 <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v6<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
        word_408042<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> v6<span class="token punctuation">]</span> <span class="token operator">=</span> v3<span class="token punctuation">;</span>
        word_408042<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> v3<span class="token punctuation">]</span> <span class="token operator">=</span> v6<span class="token punctuation">;</span>
LABEL_18<span class="token operator">:</span>
        <span class="token operator">++</span>v6<span class="token punctuation">;</span>
        <span class="token operator">++</span>v5<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'^'</span><span class="token operator">:</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_408040 <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v6<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> LABEL_18<span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token operator">--</span>v6<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> LABEL_18<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> dword_40C440 <span class="token operator">||</span> v6 <span class="token operator">==</span> <span class="token number">4096</span> <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">1</span>i64<span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_408040 <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v6<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span>i64<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>再观察<code>sub_401A0A</code>函数，可以发现其功能是执行前面翻译过来的数字指令：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">__int64 <span class="token function">sub_401A0A</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">char</span> v1<span class="token punctuation">[</span><span class="token number">10544</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+20h] [rbp-60h] BYREF</span>
  HMODULE v2<span class="token punctuation">;</span> <span class="token comment">// [rsp+2950h] [rbp+28D0h]</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+2958h] [rbp+28D8h]</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+295Ch] [rbp+28DCh]</span>

  v4 <span class="token operator">=</span> <span class="token number">10535</span><span class="token punctuation">;</span>
  v3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token operator">--</span>v4 <span class="token punctuation">)</span>
    v1<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_408040 <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v3<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> v4 <span class="token operator">&lt;=</span> <span class="token number">0x2926</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_WORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>unk_408040 <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v3<span class="token punctuation">)</span> <span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
          <span class="token operator">++</span>v4<span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_19<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
          <span class="token operator">--</span>v4<span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_19<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
          <span class="token operator">++</span>v1<span class="token punctuation">[</span>v4<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_19<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
          <span class="token operator">--</span>v1<span class="token punctuation">[</span>v4<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_19<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>
          <span class="token function">putchar</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> __int8<span class="token punctuation">)</span>v1<span class="token punctuation">[</span>v4<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_19<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span>
          v1<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_19<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v1<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token punctuation">)</span>
            v3 <span class="token operator">=</span> word_408042<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> v3<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_19<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">8</span><span class="token operator">:</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span> v1<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token punctuation">)</span>
            v3 <span class="token operator">=</span> word_408042<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> v3<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_19<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">9</span><span class="token operator">:</span>
          v1<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token operator">^=</span> v1<span class="token punctuation">[</span>v4 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
LABEL_19<span class="token operator">:</span>
          <span class="token operator">++</span>v3<span class="token punctuation">;</span>
          <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">0xA</span><span class="token operator">:</span>
          v2 <span class="token operator">=</span> <span class="token function">GetModuleHandleA</span><span class="token punctuation">(</span><span class="token number">0</span>i64<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">__int64</span> <span class="token punctuation">(</span>__fastcall <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>v2 <span class="token operator">+</span> <span class="token operator">*</span><span class="token punctuation">(</span>__int16 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>v1<span class="token punctuation">[</span>v4<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v1<span class="token punctuation">[</span>v4<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
          <span class="token keyword">return</span> <span class="token number">1</span>i64<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> v4 <span class="token operator">==</span> <span class="token number">10535</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>结合两函数可以知道，原生brainfuck符号的功能是不变的，而<code>^</code>表示当前指针处元素与地址下一个元素进行异或后赋值给自己，<code>!</code>表示branfuck段截止，进入某个函数继续进行下一步判断。</p>
<p>在前面得到了<code>sub_401624</code>里发现有返回3L和4L的情况，与<code>main</code>函数的v2对应，因此可以得知这个大概是判断函数的最后一环。</p>
<p>回到brainfuck，在动调的过程中查看原先存brainfuck的地址，发现其最后部分发生一定变化：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221010185127445.png" alt="image-20221010185127445"></p>
<p>复制下来，根据brainfuck的解释函数得知，整段brainfuck的作用是输出<code>Welcome to the brainfuck++! Plz input the flag</code>，然后获取一段长为32的字符串作为输入flag，对其进行了一系列操作处理后在<code>!</code>处传入<code>sub_401624</code>函数进行判断。于是按照vm的方法来反向写brainfuck解释器。判断函数里有一个tea算法，可以简单逆一下。</p>
<p>最后写出的逆向代码为：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span></span>

<span class="token keyword">char</span> brainfuck<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"++++++++++[>++++++++>++++++++++>++++++++++>+++++++++>+++++++++++>++++++++++>++++++++++>+++>+++++++++++>+++++++++++>+++>+++++++++++>++++++++++>++++++++++>+++>+++++++++>+++++++++++>+++++++++>++++++++++>+++++++++++>++++++++++>+++++++++++>+++++++++>++++++++++>++++>++++>+++>+&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;-]>+++++++>+>++++++++>+++++++++>+>+++++++++>+>++>++++++>+>++>++++++>++++>+>++>++++++++>++++>+++++++>+++++>>++>+++++++>+++++++++>+++++++>+++>+++>+++>&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;++++++++++++++++++++++++++++>[.>]++++++++++[>++++++++>++++++++++>++++++++++++>+++>++++++++++>+++++++++++>+++++++++++>+++++++++++>+++++++++++>+++>+++++++++++>++++++++++>++++++++++>+++>++++++++++>++++++++++>+++++++++>++++++++++>+++++&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;-]>>++++++++>++>++>+++++>>++>+++++++>++++++>++>++++++>++++>+>++>++>++++++++>+++++++>+++>++++++++&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;+++++++++++++++++++>[.>],>,>,>,>,>,>,>,>,>,>,>,>,>,>,>,>,>,>,>,>,>,>,>,>,>,>,>,>,>,>,>,>++++&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;^&lt;[-]++++++++++++++++++++++&lt;[-]++++++++++++++++++++++++++++++++++++!"</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> instruction<span class="token punctuation">[</span><span class="token number">1064</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> dword_40C440<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> word_408042<span class="token punctuation">[</span><span class="token number">8191</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">short</span> word_40C040<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> input<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"cnss&#123;abcdefghijklm2i_!ikcjc_jo9&#125;"</span><span class="token punctuation">;</span><span class="token comment">//随便输的，只是为了满足输入要求</span>

<span class="token comment">// 翻译brainfuck为数字指令</span>
<span class="token keyword">long</span> <span class="token function">translate</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>a1<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> v2<span class="token punctuation">;</span> <span class="token comment">// eax</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+26h] [rbp-5Ah]</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+28h] [rbp-58h]</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> v5<span class="token punctuation">;</span> <span class="token comment">// [rsp+2Ch] [rbp-54h]</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> v6<span class="token punctuation">;</span> <span class="token comment">// [rsp+2Eh] [rbp-52h]</span>

  v6 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  v5 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    v4 <span class="token operator">=</span> a1<span class="token punctuation">[</span>v5<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>a1<span class="token punctuation">[</span>v5<span class="token punctuation">]</span> <span class="token operator">||</span> v6 <span class="token operator">>=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span> <span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span> v4 <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">case</span> <span class="token string">'!'</span><span class="token operator">:</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>instruction <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v6<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> LABEL_18<span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'+'</span><span class="token operator">:</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>instruction <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v6<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> LABEL_18<span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">','</span><span class="token operator">:</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>instruction <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v6<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> LABEL_18<span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'-'</span><span class="token operator">:</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>instruction <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v6<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> LABEL_18<span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'.'</span><span class="token operator">:</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>instruction <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v6<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> LABEL_18<span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'&lt;'</span><span class="token operator">:</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>instruction <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v6<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> LABEL_18<span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'>'</span><span class="token operator">:</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>instruction <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v6<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> LABEL_18<span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'['</span><span class="token operator">:</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>instruction <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v6<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> dword_40C440 <span class="token operator">==</span> <span class="token number">512</span> <span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token number">1L</span><span class="token punctuation">;</span>
        v2 <span class="token operator">=</span> dword_40C440<span class="token operator">++</span><span class="token punctuation">;</span>
        word_40C040<span class="token punctuation">[</span>v2<span class="token punctuation">]</span> <span class="token operator">=</span> v6<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> LABEL_18<span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">']'</span><span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>dword_40C440 <span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token number">1L</span><span class="token punctuation">;</span>
        v3 <span class="token operator">=</span> word_40C040<span class="token punctuation">[</span><span class="token operator">--</span>dword_40C440<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>instruction <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v6<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
        word_408042<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> v6<span class="token punctuation">]</span> <span class="token operator">=</span> v3<span class="token punctuation">;</span>
        word_408042<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> v3<span class="token punctuation">]</span> <span class="token operator">=</span> v6<span class="token punctuation">;</span>
LABEL_18<span class="token operator">:</span>
        <span class="token operator">++</span>v6<span class="token punctuation">;</span>
        <span class="token operator">++</span>v5<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">'^'</span><span class="token operator">:</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>instruction <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v6<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> LABEL_18<span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token operator">--</span>v6<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> LABEL_18<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> dword_40C440 <span class="token operator">||</span> v6 <span class="token operator">==</span> <span class="token number">4096</span> <span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">1L</span><span class="token punctuation">;</span>
  <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>instruction <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v6<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0L</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">char</span> v1<span class="token punctuation">[</span><span class="token number">10544</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">//先让brainfuck正常运行以填充v1</span>
<span class="token keyword">long</span> <span class="token function">vm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
   <span class="token comment">// [rsp+20h] [rbp-60h] BYREF</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+2958h] [rbp+28D8h]</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+295Ch] [rbp+28DCh]</span>
  
  v4 <span class="token operator">=</span> <span class="token number">10535</span><span class="token punctuation">;</span>
  v3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token operator">--</span>v4 <span class="token punctuation">)</span>
    v1<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token comment">// v4 &lt;= 10534</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>instruction <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v3<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> v4 <span class="token operator">&lt;=</span> <span class="token number">0x2926</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>instruction <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v3<span class="token punctuation">)</span> <span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
          <span class="token operator">++</span>v4<span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_19<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
          <span class="token operator">--</span>v4<span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_19<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
          <span class="token operator">++</span>v1<span class="token punctuation">[</span>v4<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_19<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
          <span class="token operator">--</span>v1<span class="token punctuation">[</span>v4<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_19<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>
          <span class="token comment">// putchar((unsigned char)v1[v4]);</span>
          <span class="token keyword">goto</span> LABEL_19<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span>
          v1<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token operator">=</span> input<span class="token punctuation">[</span>v4 <span class="token operator">-</span><span class="token number">49</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_19<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v1<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token punctuation">)</span>
            v3 <span class="token operator">=</span> word_408042<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> v3<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_19<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">8</span><span class="token operator">:</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span> v1<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token punctuation">)</span>
            v3 <span class="token operator">=</span> word_408042<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> v3<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_19<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">9</span><span class="token operator">:</span>
          v1<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token operator">^=</span> v1<span class="token punctuation">[</span>v4 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
LABEL_19<span class="token operator">:</span>
          <span class="token operator">++</span>v3<span class="token punctuation">;</span>
          <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">0xA</span><span class="token operator">:</span>
          <span class="token keyword">return</span> <span class="token number">10L</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
          <span class="token keyword">return</span> <span class="token number">1L</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"v4: %d"</span><span class="token punctuation">,</span> v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> v4 <span class="token operator">==</span> <span class="token number">10535</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token operator">*</span> <span class="token function">re2</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>a1<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>a2<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">int</span> <span class="token operator">*</span>result<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> i<span class="token punctuation">;</span> <span class="token comment">// [rsp+8h] [rbp-18h]</span>
  <span class="token keyword">int</span> v4 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">957401312</span><span class="token punctuation">;</span> <span class="token comment">// [rsp+14h] [rbp-Ch]</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v5<span class="token punctuation">;</span> <span class="token comment">// [rsp+18h] [rbp-8h]</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v6<span class="token punctuation">;</span> <span class="token comment">// [rsp+1Ch] [rbp-4h]</span>

  v6 <span class="token operator">=</span> <span class="token operator">*</span>a1<span class="token punctuation">;</span>
  v5 <span class="token operator">=</span> a1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">0x1F</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    v5 <span class="token operator">-=</span> <span class="token punctuation">(</span>v6 <span class="token operator">+</span> v4<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>a2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">16</span> <span class="token operator">*</span> v6<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>v6 <span class="token operator">>></span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">+</span> a2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    v6 <span class="token operator">-=</span> <span class="token punctuation">(</span>v5 <span class="token operator">+</span> v4<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token operator">*</span>a2 <span class="token operator">+</span> <span class="token number">16</span> <span class="token operator">*</span> v5<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>v5 <span class="token operator">>></span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">+</span> a2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    v4 <span class="token operator">+=</span> <span class="token number">1640531527</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token operator">*</span>a1 <span class="token operator">=</span> v6<span class="token punctuation">;</span>
  result <span class="token operator">=</span> a1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  a1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> v5<span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">long</span> <span class="token function">re1</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> k<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">long</span> result<span class="token punctuation">;</span> <span class="token comment">// rax</span>
  <span class="token keyword">int</span> <span class="token operator">*</span>v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+48h] [rbp-18h]</span>
  <span class="token keyword">char</span> Buf1<span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">long</span> v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+50h] [rbp-10h]</span>
  <span class="token keyword">int</span> i<span class="token punctuation">;</span> <span class="token comment">// [rsp+5Ch] [rbp-4h]</span>

  Buf1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">53</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">67</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">23</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">107</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">96</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">96</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">50</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">26</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">99</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">80</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">62</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">46</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">111</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">19</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">85</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">21</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">117</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">61</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">118</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">25</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">27</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">26</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">116</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">27</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">103</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">126</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">37</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">11</span><span class="token punctuation">;</span>
  Buf1<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">63</span><span class="token punctuation">;</span>
  v4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> Buf1<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>
    <span class="token function">re2</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">8L</span> <span class="token operator">*</span> i <span class="token operator">+</span> v4<span class="token punctuation">)</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    v1<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">49</span><span class="token punctuation">]</span> <span class="token operator">=</span> Buf1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">long</span> <span class="token function">vm_re</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v3<span class="token punctuation">;</span> <span class="token comment">// [rsp+2958h] [rbp+28D8h]</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v4<span class="token punctuation">;</span> <span class="token comment">// [rsp+295Ch] [rbp+28DCh]</span>
  <span class="token keyword">char</span> v0<span class="token punctuation">[</span><span class="token number">10544</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">strcpy</span><span class="token punctuation">(</span>v0<span class="token punctuation">,</span> v1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  v4 <span class="token operator">=</span> <span class="token number">47</span><span class="token punctuation">;</span>
  v3 <span class="token operator">=</span> <span class="token number">1062</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token comment">// v4 &lt;= 10534</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>instruction <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v3<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> v4 <span class="token operator">&lt;=</span> <span class="token number">0x2926</span> <span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>instruction <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> v3<span class="token punctuation">)</span> <span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
          <span class="token operator">--</span>v4<span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_19<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
          <span class="token operator">++</span>v4<span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_19<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
          <span class="token operator">--</span>v1<span class="token punctuation">[</span>v4<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token operator">--</span>v0<span class="token punctuation">[</span>v4<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_19<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
          <span class="token operator">++</span>v1<span class="token punctuation">[</span>v4<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token operator">++</span>v0<span class="token punctuation">[</span>v4<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_19<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>
          <span class="token keyword">goto</span> LABEL_19<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span>
          <span class="token keyword">return</span> <span class="token number">1L</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span> v1<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token punctuation">)</span>
            v3 <span class="token operator">=</span> word_408042<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> v3<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_19<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">8</span><span class="token operator">:</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>v1<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token punctuation">)</span>
            v3 <span class="token operator">=</span> word_408042<span class="token punctuation">[</span><span class="token number">2</span> <span class="token operator">*</span> v3<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">goto</span> LABEL_19<span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">9</span><span class="token operator">:</span>
          v1<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token operator">^=</span> v1<span class="token punctuation">[</span>v4 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          v0<span class="token punctuation">[</span>v4<span class="token punctuation">]</span> <span class="token operator">^=</span> v0<span class="token punctuation">[</span>v4 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
LABEL_19<span class="token operator">:</span>
          <span class="token operator">--</span>v3<span class="token punctuation">;</span>
          <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">0xA</span><span class="token operator">:</span>
          <span class="token keyword">goto</span> LABEL_19<span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
          <span class="token keyword">return</span> <span class="token number">1L</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> v4 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">translate</span><span class="token punctuation">(</span>brainfuck<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">vm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">re1</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span>key<span class="token punctuation">[</span><span class="token number">47</span> <span class="token operator">-</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">vm_re</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//输出flag</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">49</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">82</span><span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c"</span><span class="token punctuation">,</span> v1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="BOSS-Crazy-Hacker"><a href="#BOSS-Crazy-Hacker" class="headerlink" title="[BOSS] Crazy Hacker"></a>[BOSS] Crazy Hacker</h2><h2 id="Real-World-互联网海盗"><a href="#Real-World-互联网海盗" class="headerlink" title="[Real World] 互联网海盗"></a>[Real World] 互联网海盗</h2><ul>
<li>参考资料：<a target="_blank" rel="noopener" href="https://www.bilibili.com/read/cv12137533">https://www.bilibili.com/read/cv12137533</a></li>
</ul>
<p>首先点击翻译并抓包，得到表单格式和url，并拉到<code>postman</code>里进行测试。</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221017105736878.png" alt="image-20221017105736878"></p>
<p>经过尝试发现不同的单词翻译起来，<code>token</code>都保持不变，推测其为固定值，直接复制。多次尝试同样发现headers部分需要附带上对应的<code>Cookie</code>和<code>Acs-Token</code>，且这两个头部可以固定不变。</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221017105932374.png" alt="image-20221017105932374"></p>
<p>于是在控制台源代码里搜索<code>sign:</code>，找到一个格式极其相似的地方，在这里下断点：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221017110141058.png" alt="image-20221017110141058"></p>
<p>回到百度翻译，重新输入内容进行翻译，发现的确在此暂停，于是单步进入，找到对应的sign函数：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221017110316353.png" alt="image-20221017110316353"></p>
<p>可以选择直接调用js代码的函数而无需专门编写一个sign函数，于是复制此源代码到一个文件。分析发现其使用webpack的方式引入函数，没有直接暴露函数接口，因此对其进行微小修改：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221017110509170.png" alt="image-20221017110509170"></p>
<p> 在源代码中找到sign函数，发现其处于对象的<code>1117</code>字段：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221017110605715.png" alt="image-20221017110605715"></p>
<p>直接尝试用<code>nodejs</code>运行此函数<code>funcs[1117](&#39;test&#39;)</code>，发现报错。找到其错误的一行：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221017110755579.png" alt="image-20221017110755579"></p>
<p>将<code>t.exports = function(t)&#123;</code>和<code>&#125;</code>删掉，使其直接运行内部的代码。</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221017111115206.png" alt="image-20221017111115206"></p>
<p>再次运行报错：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221017110850868.png" alt="image-20221017110850868"></p>
<p>因为是在<code>nodejs</code>环境，没有window对象，所以直接在浏览器调试得到window内容并复制进来。在控制台监听<code>window</code>和<code>d</code>，重新翻译并单步运行，直到得到两者的值：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221017111024953.png" alt="image-20221017111024953"></p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221017111033129.png" alt="image-20221017111033129"></p>
<p>将其替换到对应的<code>window[d]</code>，再次运行发现成功：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221017111136675.png" alt="image-20221017111136675"></p>
<p>于是可以修改代码使其成为一个<code>node module</code> ，这样就可以直接调用其函数：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221017111222885.png" alt="image-20221017111222885"></p>
<p>创建一个新的js文件来发送请求，引入此函数：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221017111259887.png" alt="image-20221017111259887"></p>
<p>最终使用node的<code>axios</code>库来发送请求：</p>
<p><img src="/2023/08/02/CNSSRecruit2022ReverseWriteup/image-20221017111334109.png" alt="image-20221017111334109"></p>

            </div>

            <!-- Post Comments -->
            
    <!-- 使用 DISQUS_CLICK -->
<div id="disqus-comment">
    <div id="disqus_thread"></div>

<!-- add animation -->
<style>
	.disqus_click_btn {
            line-height: 30px;
            margin: 0;
            min-width: 50px;
            padding: 0 14px;
            display: inline-block;
            font-family: "Roboto", "Helvetica", "Arial", sans-serif;
            font-size: 14px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0;
            overflow: hidden;
            will-change: box-shadow;
            transition: box-shadow .2s cubic-bezier(.4, 0, 1, 1), background-color .2s cubic-bezier(.4, 0, .2, 1), color .2s cubic-bezier(.4, 0, .2, 1);
            outline: 0;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            vertical-align: middle;
            border: 0;
            background: rgba(158, 158, 158, .2);
            box-shadow: 0 2px 2px 0 rgba(0, 0, 0, .14), 0 3px 1px -2px rgba(0, 0, 0, .2), 0 1px 5px 0 rgba(0, 0, 0, .12);
            color: #fff;
            background-color: #7EC0EE;
            text-shadow: 0
        }
</style>
	
<div class="btn_click_load" id="disqus_bt"> 
    <button class="disqus_click_btn">点击查看评论</button>
</div>

<!--
<script type="text/javascript">
$('.btn_click_load').click(function() {
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'http-miccall-tech'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    document.getElementById('disqus_bt').style.display = "none";
});
</script>
-->
<script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://example.com/2023/08/02/CNSSRecruit2022ReverseWriteup/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'http://example.com/2023/08/02/CNSSRecruit2022ReverseWriteup/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
</script>

<script type="text/javascript">
    $('.btn_click_load').click(function() {  //click to load comments
        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document;
            var s = d.createElement('script');
            s.src = '//http-miccall-tech.disqus.com/embed.js';
            s.setAttribute('data-timestamp', + new Date());
            (d.head || d.body).appendChild(s);
        })();
        $('.btn_click_load').css('display','none');
    });
</script>
</div>
<style>
    #disqus-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>


        </div>
        <!-- Copyright 版权 start -->
                <div id="copyright">
            <ul>
                <li>&copy;Powered By <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/" style="border-bottom: none;">hexo</a></li>
                <li>Design: <a target="_blank" rel="noopener" href="http://miccall.tech " style="border-bottom: none;">miccall</a></li>
            </ul>
            
                <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
			
        </div>
    </div>
</body>




 	
</html>
