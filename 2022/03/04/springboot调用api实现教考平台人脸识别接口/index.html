<!DOCTYPE HTML>
<html>

<head>
	<link rel="bookmark"  type="image/x-icon"  href="/img/logo_miccall.png"/>
	<link rel="shortcut icon" href="/img/logo_miccall.png">
	
			    <title>
    DdB'S BLOG
    </title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="/css/mic_main.css" />
    <link rel="stylesheet" href="/css/dropdownMenu.css" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>

    <meta name="keywords" content="ddb" />
    
    	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	 
    <noscript>
        <link rel="stylesheet" href="/css/noscript.css" />
    </noscript>
    <style type="text/css">
        body:before {
          content: ' ';
          position: fixed;
          top: 0;
          background: url('/img/bg.jpg') center 0 no-repeat;
          right: 0;
          bottom: 0;
          left: 0;
          background-size: cover; 
        }
    </style>

			    
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script async type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery.scrollex.min.js"></script>
    <script src="/js/jquery.scrolly.min.js"></script>
    <script src="/js/skel.min.js"></script>
    <script src="/js/util.js"></script>
    <script src="/js/main.js"></script>
	
<meta name="generator" content="Hexo 5.4.0"></head>
    
		
<!-- Layouts -->



<!--  代码渲染  -->
<link rel="stylesheet" href="/css/prism_coy.css" />
<link rel="stylesheet" href="/css/typo.css" />
<!-- 文章页 -->
<body class="is-loading">
    <!-- Wrapper 外包 s-->
    <div id="wrapper" class="fade-in">
        <!-- Intro 头部显示 s -->
        <!-- Intro 头部显示 e -->
        <!-- Header 头部logo start -->
        <header id="header">
    <a href="/" class="logo">ForeverDdB</a>
</header>
        <!-- Nav 导航条 start -->
        <nav id="nav" class="special" >
            <ul class="menu links" >
			<!-- Homepage  主页  --> 
			<li >
	            <a href="/" rel="nofollow">主页</a>
	        </li>
			<!-- categories_name  分类   --> 
	        
	        <li class="active">
	            <a href="#s1">分类</a>
	                    <ul class="submenu">
	                        <li>
	                        <a class="category-link" href="/categories/%E6%90%9E%E6%9C%BA/">搞机</a></li><li><a class="category-link" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a>
	                    </ul>
	        </li>
	        
	        <!-- archives  归档   --> 
	        
	        <li class="active">
	            <a href="#s1">归档</a>
	                    <ul class="submenu">
	                        <li>
	                        <a class="archive-link" href="/archives/2023/08/">八月 2023</a></li><li><a class="archive-link" href="/archives/2023/06/">六月 2023</a></li><li><a class="archive-link" href="/archives/2023/04/">四月 2023</a></li><li><a class="archive-link" href="/archives/2022/03/">三月 2022</a></li><li><a class="archive-link" href="/archives/2021/09/">九月 2021</a></li><li><a class="archive-link" href="/archives/2021/08/">八月 2021</a></li><li><a class="archive-link" href="/archives/2021/06/">六月 2021</a>
	                    </ul>
	        </li>
	        
	        
		        <!-- Pages 自定义   -->
		        
		        <li>
		            <a href="/about/" title="个人">
		                个人
		            </a>
		        </li>
		        
		        <li>
		            <a target="_blank" rel="noopener" href="https://img.foreverddb.top" title="图库">
		                图库
		            </a>
		        </li>
		        


            </ul>
            <!-- icons 图标   -->
			<ul class="icons">
                    
                    <li>
                        <a title="github" href="https://github.com/foreverddb" target="_blank" rel="noopener">
                            <i class="icon fa fa-github"></i>
                        </a>
                    </li>
                    
			</ul>
</nav>

        <div id="main" >
            <div class ="post_page_title_img" style="height: 25rem;background-image: url(/img/src=http___www.west.cn_info_upload_20191105_cip25l0gdyu.jpg&amp;refer=http___www.west.jpg);background-position: center; background-repeat:no-repeat; background-size:cover;-moz-background-size:cover;overflow:hidden;" >
                <a href="#" style="padding: 4rem 4rem 2rem 4rem ;"><h2 >springboot调用api实现教考平台人脸识别接口</h2></a>
            </div>
            <!-- Post -->
            <div class="typo" style="padding: 3rem;">
                <p><strong>由于服创项目的教考平台需要一个考试过程学生人脸认证的功能，因此使用springboot调用现成的API实现后端接口。</strong></p>
<h1 id="最终结果示例"><a href="#最终结果示例" class="headerlink" title="最终结果示例"></a>最终结果示例</h1><p>先看看最终结果：</p>
<p>请求对应 api ，得到人脸分析的结果：</p>
<p><img src="/2022/03/04/springboot%E8%B0%83%E7%94%A8api%E5%AE%9E%E7%8E%B0%E6%95%99%E8%80%83%E5%B9%B3%E5%8F%B0%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB%E6%8E%A5%E5%8F%A3/image-20220305135047008.png" alt="image-20220305135047008"></p>
<p><img src="/2022/03/04/springboot%E8%B0%83%E7%94%A8api%E5%AE%9E%E7%8E%B0%E6%95%99%E8%80%83%E5%B9%B3%E5%8F%B0%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB%E6%8E%A5%E5%8F%A3/image-20220305135116878.png" alt="image-20220305135116878"></p>
<h1 id="项目准备"><a href="#项目准备" class="headerlink" title="项目准备"></a>项目准备</h1><h2 id="注册Api"><a href="#注册Api" class="headerlink" title="注册Api"></a>注册Api</h2><p>使用了Face++的人脸识别接口： <a target="_blank" rel="noopener" href="https://www.faceplusplus.com.cn/">https://www.faceplusplus.com.cn/</a></p>
<p>使用本接口首先在官网上注册账号，完成后进入控制台：</p>
<p><img src="/2022/03/04/springboot%E8%B0%83%E7%94%A8api%E5%AE%9E%E7%8E%B0%E6%95%99%E8%80%83%E5%B9%B3%E5%8F%B0%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB%E6%8E%A5%E5%8F%A3/image-20220304183455307.png" alt="image-20220304183455307"></p>
<p>在<strong>应用管理 - API Key</strong> 里，选择<strong>创建 API Key</strong> ：</p>
<p><img src="/2022/03/04/springboot%E8%B0%83%E7%94%A8api%E5%AE%9E%E7%8E%B0%E6%95%99%E8%80%83%E5%B9%B3%E5%8F%B0%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB%E6%8E%A5%E5%8F%A3/image-20220304183816554.png" alt="image-20220304183816554"></p>
<p>创建成功后复制得到对应的 <strong>API Key</strong> 和 <strong>API Secret</strong> 。</p>
<p>这就是后面调用 api 时需要用到的参数。</p>
<h2 id="创建Springboot项目"><a href="#创建Springboot项目" class="headerlink" title="创建Springboot项目"></a>创建Springboot项目</h2><p>本项目的 Maven 依赖如下：</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml">      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-devtools<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

<span class="token comment">&lt;!-- 数据库相关 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-jpa<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

<span class="token comment">&lt;!-- 一些工具包 --></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-configuration-processor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.2.79<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.squareup.okhttp3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>okhttp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.3.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用了 fastjson 来帮助处理 Json 格式数据，用 okHttp 来进行 api 请求。</p>
<p>项目编写的包结构如下：</p>
<p><img src="/2022/03/04/springboot%E8%B0%83%E7%94%A8api%E5%AE%9E%E7%8E%B0%E6%95%99%E8%80%83%E5%B9%B3%E5%8F%B0%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB%E6%8E%A5%E5%8F%A3/image-20220304190047962.png" alt="image-20220304190047962"></p>
<p>建立的数据库表user_face为：</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">create table user_face
(
   user_id int not null,
   face_token char(32) null,
   constraint user_faces_pk
      primary key (user_id)
);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="配置类和工具类"><a href="#配置类和工具类" class="headerlink" title="配置类和工具类"></a>配置类和工具类</h1><h2 id="Api-配置类"><a href="#Api-配置类" class="headerlink" title="Api 配置类"></a>Api 配置类</h2><h3 id="com-example-faceIdentity-config-ApiComponent"><a href="#com-example-faceIdentity-config-ApiComponent" class="headerlink" title="com.example.faceIdentity.config.ApiComponent"></a>com.example.faceIdentity.config.ApiComponent</h3><p>这个类用于每次请求 api 的时候带上这个类的参数来认证 api：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"com.example.face-identity.api-component"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApiComponent</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> api_key<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> api_secret<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="com-example-faceIdentity-config-ApiUrl"><a href="#com-example-faceIdentity-config-ApiUrl" class="headerlink" title="com.example.faceIdentity.config.ApiUrl"></a>com.example.faceIdentity.config.ApiUrl</h3><p>这个类用于配置不同 api 请求的地址：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"com.example.face-identity.api-url"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApiUrl</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//人脸检测api</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> detect_url<span class="token punctuation">;</span>
    <span class="token comment">//人脸分析api</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> analyze_url<span class="token punctuation">;</span>
    <span class="token comment">//人脸对比api</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> compare_url<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="在application-yml中配置"><a href="#在application-yml中配置" class="headerlink" title="在application.yml中配置"></a>在application.yml中配置</h3><p>对以上编写的属性进行配置：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">com.example.faceIdentity</span><span class="token punctuation">:</span>
  <span class="token key atrule">ApiComponent</span><span class="token punctuation">:</span>
    <span class="token key atrule">api-key</span><span class="token punctuation">:</span> 填入自己的 api key
    <span class="token key atrule">api-secret</span><span class="token punctuation">:</span> 填入自己的 api secret
  <span class="token key atrule">ApiUrl</span><span class="token punctuation">:</span>
    <span class="token key atrule">detect-url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//api<span class="token punctuation">-</span>cn.faceplusplus.com/facepp/v3/detect
    <span class="token key atrule">analyze-url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//api<span class="token punctuation">-</span>cn.faceplusplus.com/facepp/v3/face/analyze
    <span class="token key atrule">compare-url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//api<span class="token punctuation">-</span>cn.faceplusplus.com/facepp/v3/compare<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>由于调用的 api 有上传文件大小的限制，我们在此直接将其限制在调用 api 前：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">servlet</span><span class="token punctuation">:</span>
    <span class="token key atrule">multipart</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">file-size-threshold</span><span class="token punctuation">:</span> <span class="token number">0</span>
      <span class="token key atrule">max-file-size</span><span class="token punctuation">:</span> 2MB
      <span class="token key atrule">max-request-size</span><span class="token punctuation">:</span> 20MB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="数据库配置类"><a href="#数据库配置类" class="headerlink" title="数据库配置类"></a>数据库配置类</h2><h3 id="com-example-faceIdentity-entity-UserFace"><a href="#com-example-faceIdentity-entity-UserFace" class="headerlink" title="com.example.faceIdentity.entity.UserFace"></a>com.example.faceIdentity.entity.UserFace</h3><p>这个类是数据库表user_face的映射，与表结构相同：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"user_face"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserFace</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> faceToken<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="com-example-faceIdentity-repository-UserFaceRepository"><a href="#com-example-faceIdentity-repository-UserFaceRepository" class="headerlink" title="com.example.faceIdentity.repository.UserFaceRepository"></a>com.example.faceIdentity.repository.UserFaceRepository</h3><p>用了 Spring-data-jpa 后只需声明一个继承自 CrudRepository 接口的接口，会自动根据方法名生成对应的实现方法：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserFaceRepository</span> <span class="token keyword">extends</span> <span class="token class-name">CrudRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserFace</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">UserFace</span> <span class="token function">findByUserId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//只需要一个通过id查询face的方法</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>后面使用时直接在 controller 里注入：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">UserFaceRepository</span> repository<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>同时还会自动生成很多数据库基础方法，如 save(UserFace),  findAll() 等。</p>
<h3 id="在application-yml中配置-1"><a href="#在application-yml中配置-1" class="headerlink" title="在application.yml中配置"></a>在application.yml中配置</h3><p>这里是配置一些 springboot 连接数据库的内容，这样 jpa 可以在运行时自动生成相应的 jdbc 连接。</p>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/test<span class="token punctuation">?</span>characterEncoding=UTF<span class="token punctuation">-</span><span class="token number">8</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> xxx
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="基础工具类"><a href="#基础工具类" class="headerlink" title="基础工具类"></a>基础工具类</h2><p>因为有些处理文件和 Http 请求的需求，但是懒得导一堆包了，直接写俩工具类。</p>
<h3 id="com-example-faceIdentity-util-FileEncoder"><a href="#com-example-faceIdentity-util-FileEncoder" class="headerlink" title="com.example.faceIdentity.util.FileEncoder"></a>com.example.faceIdentity.util.FileEncoder</h3><p>这个类用来把上传的图片转 <strong>base64</strong></p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileEncoder</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">multipartFileToBase64</span><span class="token punctuation">(</span><span class="token class-name">MultipartFile</span> file<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//将文件存入byte数组</span>
            <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">BufferedInputStream</span> bufferedInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> len <span class="token operator">=</span> bufferedInputStream<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fileData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bufferedInputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>fileData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token comment">//文件转base64</span>
            <span class="token class-name">BASE64Encoder</span> encoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BASE64Encoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> base64Str <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>fileData<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> base64Str<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="com-example-faceIdentity-util-UrlFormEncoder"><a href="#com-example-faceIdentity-util-UrlFormEncoder" class="headerlink" title="com.example.faceIdentity.util.UrlFormEncoder"></a>com.example.faceIdentity.util.UrlFormEncoder</h3><p>这个类用于在 url 后面加上需要的参数：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UrlFormEncoder</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">encodeWithParams</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">,</span> <span class="token class-name">JSONObject</span> params<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">StringBuffer</span> stringBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>params<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            stringBuffer<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token operator">:</span> params<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            stringBuffer<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>key <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> params<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            stringBuffer<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"&amp;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> stringBuffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="主体数据结构"><a href="#主体数据结构" class="headerlink" title="主体数据结构"></a>主体数据结构</h1><p><strong>调用 api 最重要的就是要熟悉 api 的请求和响应结构，并且严格按照其规范来编写对应的映射类。</strong></p>
<p>由于项目主要用到的 api 是这三个：</p>
<p><img src="/2022/03/04/springboot%E8%B0%83%E7%94%A8api%E5%AE%9E%E7%8E%B0%E6%95%99%E8%80%83%E5%B9%B3%E5%8F%B0%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB%E6%8E%A5%E5%8F%A3/image-20220305131519229.png" alt="image-20220305131519229"></p>
<p>研究其文档发现其响应格式有一个通用结构，其类映射如下：</p>
<h2 id="响应数据格式"><a href="#响应数据格式" class="headerlink" title="响应数据格式"></a>响应数据格式</h2><h3 id="com-example-faceIdentity-data-FaceGenericResponse"><a href="#com-example-faceIdentity-data-FaceGenericResponse" class="headerlink" title="com.example.faceIdentity.data.FaceGenericResponse"></a>com.example.faceIdentity.data.FaceGenericResponse</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * @author ForeverDdB 835236331@qq.com
 * @ClassName FaceDetection
 * @Description 通用人脸识别api返回数据格式
 * @createTime 2022年 02月21日 18:02
 **/</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span><span class="token punctuation">(</span>force <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FaceGenericResponse</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> request_id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> time_used<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Face</span><span class="token punctuation">></span></span> faces<span class="token punctuation">;</span><span class="token comment">//一个储存了多个人脸数据的数组</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> face_num<span class="token punctuation">;</span><span class="token comment">//检测到的人脸数量</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>对于每个检测出的人脸，我们也编写一个相应的映射：</p>
<h3 id="com-example-faceIdentity-data-Face"><a href="#com-example-faceIdentity-data-Face" class="headerlink" title="com.example.faceIdentity.data.Face"></a>com.example.faceIdentity.data.Face</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * @author ForeverDdB 835236331@qq.com
 * @ClassName Face
 * @Description 人脸数据模型
 * @createTime 2022年 02月22日 21:51
 **/</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span><span class="token punctuation">(</span>force <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Face</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> face_token<span class="token punctuation">;</span><span class="token comment">//返回对应的人脸token</span>
    <span class="token keyword">private</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">></span></span> face_rectangle<span class="token punctuation">;</span><span class="token comment">//人脸在图片中所处位置矩阵</span>
    <span class="token keyword">private</span> <span class="token class-name">FaceAttributes</span> attributes<span class="token punctuation">;</span><span class="token comment">//人脸相关参数</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="com-example-faceIdentity-data-FaceAttributes"><a href="#com-example-faceIdentity-data-FaceAttributes" class="headerlink" title="com.example.faceIdentity.data.FaceAttributes"></a>com.example.faceIdentity.data.FaceAttributes</h3><p>下列每个属性的注释均来自于 api 官方文档：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span><span class="token punctuation">(</span>force <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FaceAttributes</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//性别分析结果。返回值为：</span>
    <span class="token comment">//Male	男性</span>
    <span class="token comment">//Female	女性</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> gender<span class="token punctuation">;</span>

    <span class="token comment">//年龄分析结果。返回值为一个非负整数。</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>

    <span class="token comment">//笑容分析结果。返回值包含以下属性：</span>
    <span class="token comment">//value：值为一个 [0,100] 的浮点数，小数点后3位有效数字。数值越大表示笑程度高。</span>
    <span class="token comment">//threshold：代表笑容的阈值，超过该阈值认为有笑容。</span>
    <span class="token keyword">private</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Float</span><span class="token punctuation">></span></span> smile<span class="token punctuation">;</span>

    <span class="token comment">//人脸姿势分析结果。返回值包含以下属性，每个属性的值为一个 [-180, 180] 的浮点数，小数点后 6 位有效数字。单位为角度。</span>
    <span class="token comment">//pitch_angle：抬头</span>
    <span class="token comment">//roll_angle：旋转（平面旋转）</span>
    <span class="token comment">//yaw_angle：摇头</span>
    <span class="token keyword">private</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Float</span><span class="token punctuation">></span></span> headpose<span class="token punctuation">;</span>

    <span class="token comment">//人脸模糊分析结果。返回值包含以下属性：</span>
    <span class="token comment">//blurness：新的人脸模糊分析结果。</span>
    <span class="token comment">//每个属性都包含以下字段：</span>
    <span class="token comment">//value 的值为是一个浮点数，范围 [0,100]，小数点后 3 位有效数字。</span>
    <span class="token comment">//threshold 表示人脸模糊度是否影响辨识的阈值。</span>
    <span class="token keyword">private</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">HashMap</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Float</span><span class="token punctuation">></span><span class="token punctuation">></span></span> blur<span class="token punctuation">;</span>

    <span class="token comment">//眼睛状态信息。返回值包含以下属性：</span>
    <span class="token comment">//left_eye_status：左眼的状态</span>
    <span class="token comment">//right_eye_status：右眼的状态</span>
    <span class="token comment">//每个属性都包含以下字段。每个字段的值都是一个浮点数，范围 [0,100]，小数点后 3 位有效数字。字段值的总和等于 100。</span>
    <span class="token comment">//occlusion：眼睛被遮挡的置信度</span>
    <span class="token comment">//no_glass_eye_open：不戴眼镜且睁眼的置信度</span>
    <span class="token comment">//normal_glass_eye_close：佩戴普通眼镜且闭眼的置信度</span>
    <span class="token comment">//normal_glass_eye_open：佩戴普通眼镜且睁眼的置信度</span>
    <span class="token comment">//dark_glasses：佩戴墨镜的置信度</span>
    <span class="token comment">//no_glass_eye_close：不戴眼镜且闭眼的置信度</span>
    <span class="token keyword">private</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">HashMap</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Float</span><span class="token punctuation">></span><span class="token punctuation">></span></span> eyestatus<span class="token punctuation">;</span>

    <span class="token comment">//情绪识别结果。返回值包含以下字段。每个字段的值都是一个浮点数，范围 [0,100]，小数点后 3 位有效数字。每个字段的返回值越大，则该字段代表的状态的置信度越高。字段值的总和等于 100。</span>
    <span class="token comment">//anger：愤怒</span>
    <span class="token comment">//disgust：厌恶</span>
    <span class="token comment">//fear：恐惧</span>
    <span class="token comment">//happiness：高兴</span>
    <span class="token comment">//neutral：平静</span>
    <span class="token comment">//sadness：伤心</span>
    <span class="token comment">//surprise：惊讶</span>
    <span class="token keyword">private</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Float</span><span class="token punctuation">></span></span> emotion<span class="token punctuation">;</span>

    <span class="token comment">//人脸质量判断结果。返回值包含以下属性：</span>
    <span class="token comment">//value：值为人脸的质量判断的分数，是一个浮点数，范围 [0,100]，小数点后 3 位有效数字。</span>
    <span class="token comment">//threshold：表示人脸质量基本合格的一个阈值，超过该阈值的人脸适合用于人脸比对。</span>
    <span class="token keyword">private</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Float</span><span class="token punctuation">></span></span> facequality<span class="token punctuation">;</span>

    <span class="token comment">//颜值识别结果。返回值包含以下两个字段。每个字段的值是一个浮点数，范围 [0,100]，小数点后 3 位有效数字。</span>
    <span class="token comment">//male_score：男性认为的此人脸颜值分数。值越大，颜值越高。</span>
    <span class="token comment">//female_score：女性认为的此人脸颜值分数。值越大，颜值越高。</span>
    <span class="token keyword">private</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Float</span><span class="token punctuation">></span></span> beauty<span class="token punctuation">;</span>

    <span class="token comment">//嘴部状态信息，包括以下字段。每个字段的值都是一个浮点数，范围 [0,100]，小数点后 3 位有效数字。字段值的总和等于 100。</span>
    <span class="token comment">//surgical_mask_or_respirator：嘴部被医用口罩或呼吸面罩遮挡的置信度</span>
    <span class="token comment">//other_occlusion：嘴部被其他物体遮挡的置信度</span>
    <span class="token comment">//close：嘴部没有遮挡且闭上的置信度</span>
    <span class="token comment">//open：嘴部没有遮挡且张开的置信度</span>
    <span class="token keyword">private</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Float</span><span class="token punctuation">></span></span> mouthstatus<span class="token punctuation">;</span>

    <span class="token comment">//眼球位置与视线方向信息。返回值包括以下属性：</span>
    <span class="token comment">//left_eye_gaze：左眼的位置与视线状态</span>
    <span class="token comment">//right_eye_gaze：右眼的位置与视线状态</span>
    <span class="token comment">//每个属性都包括以下字段，每个字段的值都是一个浮点数，小数点后 3 位有效数字。</span>
    <span class="token comment">//position_x_coordinate: 眼球中心位置的 X 轴坐标。</span>
    <span class="token comment">//position_y_coordinate: 眼球中心位置的 Y 轴坐标。</span>
    <span class="token comment">//vector_x_component: 眼球视线方向向量的 X 轴分量。</span>
    <span class="token comment">//vector_y_component: 眼球视线方向向量的 Y 轴分量。</span>
    <span class="token comment">//vector_z_component: 眼球视线方向向量的 Z 轴分量。</span>
    <span class="token keyword">private</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">HashMap</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Float</span><span class="token punctuation">></span><span class="token punctuation">></span></span> eyegaze<span class="token punctuation">;</span>

    <span class="token comment">//面部特征识别结果，包括以下字段。每个字段的值都是一个浮点数，范围 [0,100]，小数点后 3 位有效数字。每个字段的返回值越大，则该字段代表的状态的置信度越高。</span>
    <span class="token comment">//health：健康</span>
    <span class="token comment">//stain：色斑</span>
    <span class="token comment">//acne：青春痘</span>
    <span class="token comment">//dark_circle：黑眼圈</span>
    <span class="token keyword">private</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Float</span><span class="token punctuation">></span></span> skinstatus<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="com-example-faceIdentity-data-FaceCompareResponse"><a href="#com-example-faceIdentity-data-FaceCompareResponse" class="headerlink" title="com.example.faceIdentity.data.FaceCompareResponse"></a>com.example.faceIdentity.data.FaceCompareResponse</h3><p>人脸对比 api 的结果稍有不同，我在此还加入了几个验证结果有效性的方法。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span><span class="token punctuation">(</span>force <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FaceCompareResponse</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">Float</span> confidence<span class="token punctuation">;</span><span class="token comment">//人脸对比的结果</span>
    <span class="token keyword">private</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Float</span><span class="token punctuation">></span></span> thresholds<span class="token punctuation">;</span><span class="token comment">//一组阈值，对比结果超过此阈值即可认为是同一个人</span>
    <span class="token comment">/**
     * 校验是否进行了有效的人脸对比
     * @method isValid
     * @return boolean
     *
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>confidence <span class="token operator">></span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">/**
     * 校验是否匹配人脸
     * @method isMatched
     * @return boolean
     *
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isMatched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//这里用万分之一阈值</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>thresholds<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"1e-4"</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> confidence<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="请求数据格式"><a href="#请求数据格式" class="headerlink" title="请求数据格式"></a>请求数据格式</h2><p>由于不同 api 所需的请求格式不尽相同，因此针对每个 api 写一个对应的请求类。</p>
<h3 id="com-example-faceIdentity-data-FaceDetectionRequest"><a href="#com-example-faceIdentity-data-FaceDetectionRequest" class="headerlink" title="com.example.faceIdentity.data.FaceDetectionRequest"></a>com.example.faceIdentity.data.FaceDetectionRequest</h3><p>人脸检测 api 只需要一个人脸图片参数，在此以 base64 形式上传：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * @author ForeverDdB 835236331@qq.com
 * @ClassName FaceDetectionRequest
 * @Description 人脸检测api发送请求格式
 * @createTime 2022年 02月21日 18:53
 **/</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FaceDetectionRequest</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> image_base64<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="com-example-faceIdentity-data-FaceAnalyzeRequest"><a href="#com-example-faceIdentity-data-FaceAnalyzeRequest" class="headerlink" title="com.example.faceIdentity.data.FaceAnalyzeRequest"></a>com.example.faceIdentity.data.FaceAnalyzeRequest</h3><p>人脸分析是采用人脸检测结果得到的人脸 token 作为人脸参数，同时还需带上需要分析的属性参数。</p>
<p>由于项目需求只采用 facequality 参数，分析可得到此人脸是否适合作为后续人脸对比的基础图片阈值。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * @author ForeverDdB 835236331@qq.com
 * @ClassName FaceAnalyzeRequest
 * @Description 人脸分析api发送请求格式
 * @createTime 2022年 02月22日 21:27
 **/</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FaceAnalyzeRequest</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> face_tokens<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> return_attributes <span class="token operator">=</span> <span class="token string">"headpose,facequality"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="com-example-faceIdentity-data-FaceGenericResponse-1"><a href="#com-example-faceIdentity-data-FaceGenericResponse-1" class="headerlink" title="com.example.faceIdentity.data.FaceGenericResponse"></a>com.example.faceIdentity.data.FaceGenericResponse</h3><p>人脸对比只需传入两张需要对比的人脸，在项目中其中一张人脸来自于数据库中储存的对应用户人脸。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * @author ForeverDdB 835236331@qq.com
 * @ClassName FaceCompareRequest
 * @Description 人脸对比api返回结果
 * @createTime 2022年 02月26日 22:41
 **/</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FaceCompareRequest</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> face_token1<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> face_token2<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="编写程序主体"><a href="#编写程序主体" class="headerlink" title="编写程序主体"></a>编写程序主体</h1><h2 id="控制器"><a href="#控制器" class="headerlink" title="控制器"></a>控制器</h2><p>需要开发的 api 不多，因此用一个控制器即可完成功能。</p>
<p>此控制器中需要用编写的 Service 来进行人脸 api 方面的处理，相关描述在控制器后面部分。</p>
<h3 id="com-example-faceIdentity-controller-FaceController"><a href="#com-example-faceIdentity-controller-FaceController" class="headerlink" title="com.example.faceIdentity.controller.FaceController"></a>com.example.faceIdentity.controller.FaceController</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/api/face"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@MultipartConfig</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FaceController</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ApiService</span> apiService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserFaceRepository</span> repository<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 上传人脸图片并调用api处理请求
     *
     * @param file: 人脸图片
     * @return java.lang.String
     * @method faceCheck
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">CustomResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FaceGenericResponse</span><span class="token punctuation">></span></span> <span class="token function">faceDetect</span><span class="token punctuation">(</span><span class="token class-name">MultipartFile</span> file<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//图片转base64</span>
        <span class="token class-name">String</span> base64Str <span class="token operator">=</span> <span class="token class-name">FileEncoder</span><span class="token punctuation">.</span><span class="token function">multipartFileToBase64</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//检测人脸</span>
        <span class="token class-name">FaceDetectionRequest</span> faceDetectRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FaceDetectionRequest</span><span class="token punctuation">(</span>base64Str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FaceGenericResponse</span> faceDetectResponse <span class="token operator">=</span> apiService<span class="token punctuation">.</span><span class="token function">processFace</span><span class="token punctuation">(</span>faceDetectRequest<span class="token punctuation">,</span> <span class="token class-name">ApiService<span class="token punctuation">.</span>ApiType</span><span class="token punctuation">.</span>DETECT<span class="token punctuation">,</span> <span class="token class-name">FaceGenericResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//分析人脸</span>
        <span class="token class-name">CustomResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FaceGenericResponse</span><span class="token punctuation">></span></span> response <span class="token operator">=</span> apiService<span class="token punctuation">.</span><span class="token function">processFaceAttr</span><span class="token punctuation">(</span>faceDetectResponse<span class="token punctuation">,</span> <span class="token class-name">ApiService<span class="token punctuation">.</span>AttrType</span><span class="token punctuation">.</span>BASIC<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 上传人脸认证图片并保存到数据库
     * @param file: 人脸图片
     * @param userId: 对应人脸的用户id
     * @method faceSave
     * @return com.example.faceIdentity.data.CustomResponse&lt;com.example.faceIdentity.entity.UserFace>
     *
     */</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/uploadFace"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">CustomResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserFace</span><span class="token punctuation">></span></span> <span class="token function">faceSave</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"face"</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> file<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">CustomResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserFace</span><span class="token punctuation">></span></span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">//检测人脸</span>
            <span class="token class-name">CustomResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FaceGenericResponse</span><span class="token punctuation">></span></span> faceDetectResponse <span class="token operator">=</span> <span class="token function">faceDetect</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>faceDetectResponse<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"成功"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token comment">//获取对应人脸token</span>
                <span class="token class-name">UserFace</span> userFace <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserFace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                userFace<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                userFace<span class="token punctuation">.</span><span class="token function">setFaceToken</span><span class="token punctuation">(</span>faceDetectResponse<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFace_token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//将人脸存入对应用户数据库</span>
                repository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>userFace<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//返回响应</span>
                response<span class="token punctuation">.</span><span class="token function">setMsg</span><span class="token punctuation">(</span><span class="token string">"人脸认证图片上传成功！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>userFace<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                response<span class="token punctuation">.</span><span class="token function">setMsg</span><span class="token punctuation">(</span>faceDetectResponse<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setMsg</span><span class="token punctuation">(</span><span class="token string">"人脸数据检测失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 上传人脸图片并返回与相应用户对比的结果
     *
     * @param file:   人脸图片
     * @param userId: 需要对比的用户id
     * @return com.example.faceIdentity.data.CustomResponse&lt;com.example.faceIdentity.data.FaceCompareResponse>
     * @method faceCompare
     */</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/compare"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">CustomResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FaceCompareResponse</span><span class="token punctuation">></span></span> <span class="token function">faceCompare</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"face"</span><span class="token punctuation">)</span> <span class="token class-name">MultipartFile</span> file<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//图片转base64</span>
        <span class="token class-name">String</span> base64Str <span class="token operator">=</span> <span class="token class-name">FileEncoder</span><span class="token punctuation">.</span><span class="token function">multipartFileToBase64</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取用户对应人脸token</span>
        <span class="token class-name">UserFace</span> userFace <span class="token operator">=</span> repository<span class="token punctuation">.</span><span class="token function">findByUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> face_token2 <span class="token operator">=</span> userFace<span class="token punctuation">.</span><span class="token function">getFaceToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取人脸</span>
        <span class="token class-name">FaceDetectionRequest</span> faceDetectRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FaceDetectionRequest</span><span class="token punctuation">(</span>base64Str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FaceGenericResponse</span> faceDetectResponse <span class="token operator">=</span> apiService<span class="token punctuation">.</span><span class="token function">processFace</span><span class="token punctuation">(</span>faceDetectRequest<span class="token punctuation">,</span> <span class="token class-name">ApiService<span class="token punctuation">.</span>ApiType</span><span class="token punctuation">.</span>DETECT<span class="token punctuation">,</span> <span class="token class-name">FaceGenericResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Face</span><span class="token punctuation">></span></span> faces <span class="token operator">=</span> faceDetectResponse<span class="token punctuation">.</span><span class="token function">getFaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CustomResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FaceCompareResponse</span><span class="token punctuation">></span></span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setMsg</span><span class="token punctuation">(</span><span class="token string">"人脸不匹配"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>faces<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            response<span class="token punctuation">.</span><span class="token function">setMsg</span><span class="token punctuation">(</span><span class="token string">"未检测到有效人脸"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> response<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//对比图片中每一个人脸</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Face</span> face <span class="token operator">:</span> faces<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">String</span> face_token1 <span class="token operator">=</span> face<span class="token punctuation">.</span><span class="token function">getFace_token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">FaceCompareRequest</span> faceCompareRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FaceCompareRequest</span><span class="token punctuation">(</span>face_token1<span class="token punctuation">,</span> face_token2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">FaceCompareResponse</span> faceCompareResponse <span class="token operator">=</span> apiService<span class="token punctuation">.</span><span class="token function">processFace</span><span class="token punctuation">(</span>faceCompareRequest<span class="token punctuation">,</span> <span class="token class-name">ApiService<span class="token punctuation">.</span>ApiType</span><span class="token punctuation">.</span>COMPARE<span class="token punctuation">,</span> <span class="token class-name">FaceCompareResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>faceCompareResponse<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>faceCompareResponse<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> faceCompareResponse<span class="token punctuation">.</span><span class="token function">isMatched</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                response<span class="token punctuation">.</span><span class="token function">setMsg</span><span class="token punctuation">(</span><span class="token string">"人脸匹配成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>faceCompareResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="com-example-faceIdentity-data-CustomResponse"><a href="#com-example-faceIdentity-data-CustomResponse" class="headerlink" title="com.example.faceIdentity.data.CustomResponse"></a>com.example.faceIdentity.data.CustomResponse</h3><p>该控制器中用到了自定义的一个泛型类，用于向用户返回一个通用的响应体：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@NoArgsConstructor</span><span class="token punctuation">(</span>force <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> msg<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> success<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">T</span> data<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><p>这是用于处理控制器中需要用到的人脸 api 处理请求，编写了几个通用的服务。</p>
<p>主体使用了 okhttp 来进行 http 请求以调用 api，同时其方法对 api 结果进行了处理，最后只返回通用的简单响应体结构。</p>
<p>使用 @Service 注解来使其可以被自动扫描注入：</p>
<h3 id="com-example-faceIdentity-service-ApiService"><a href="#com-example-faceIdentity-service-ApiService" class="headerlink" title="com.example.faceIdentity.service.ApiService"></a>com.example.faceIdentity.service.ApiService</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApiService</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ApiComponent</span> apiComponent<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ApiUrl</span> apiUrl<span class="token punctuation">;</span>
    <span class="token comment">//api类型</span>
    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">ApiType</span><span class="token punctuation">&#123;</span>
        DETECT<span class="token punctuation">,</span> <span class="token comment">//检测人脸</span>
        ANALYZE<span class="token punctuation">,</span> <span class="token comment">//分析人脸</span>
        COMPARE <span class="token comment">//对比人脸</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">AttrType</span><span class="token punctuation">&#123;</span>
        BASIC<span class="token punctuation">,</span> <span class="token comment">//人脸基本属性分析</span>
        ACTION<span class="token punctuation">,</span> <span class="token comment">//分析人脸动作</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">/**
     * 需要对url添加的参数
     * @param builder: http请求builder
     * @param params: 需要添加的form-data参数
     * @method addFormParts
     * @return okhttp3.MultipartBody.Builder 添加了参数后的builder
     *
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">MultipartBody<span class="token punctuation">.</span>Builder</span> <span class="token function">addFormParts</span><span class="token punctuation">(</span><span class="token class-name">MultipartBody<span class="token punctuation">.</span>Builder</span> builder<span class="token punctuation">,</span> <span class="token class-name">JSONObject</span> params<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token operator">:</span> params<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            builder<span class="token punctuation">.</span><span class="token function">addFormDataPart</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> params<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> builder<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 处理不同类型的人脸识别需求
     * @param objParams: 上传到api所需参数
     * @param type: 人脸识别服务类型
     * @param tClass: 需要的返回对象类型
     * @method processFace
     * @return com.alibaba.fastjson.JSONObject 识别结果
     *
     */</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">processFace</span><span class="token punctuation">(</span><span class="token class-name">Object</span> objParams<span class="token punctuation">,</span> <span class="token class-name">ApiType</span> type<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> tClass<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">//将请求对象转换为json</span>
        <span class="token class-name">JSONObject</span> params <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>objParams<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//根据请求类型确定请求url</span>
        <span class="token class-name">String</span> rootUrl <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">case</span> DETECT<span class="token operator">:</span>
                rootUrl <span class="token operator">=</span> apiUrl<span class="token punctuation">.</span><span class="token function">getDetect_url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> ANALYZE<span class="token operator">:</span>
                rootUrl <span class="token operator">=</span> apiUrl<span class="token punctuation">.</span><span class="token function">getAnalyze_url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> COMPARE<span class="token operator">:</span>
                rootUrl <span class="token operator">=</span> apiUrl<span class="token punctuation">.</span><span class="token function">getCompare_url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//创建请求对象</span>
        <span class="token class-name">JSONObject</span> urlParams <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>apiComponent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> reqUrl <span class="token operator">=</span> <span class="token class-name">UrlFormEncoder</span><span class="token punctuation">.</span><span class="token function">encodeWithParams</span><span class="token punctuation">(</span>rootUrl<span class="token punctuation">,</span> urlParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//处理http请求</span>
        <span class="token class-name">OkHttpClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OkHttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">connectTimeout</span><span class="token punctuation">(</span><span class="token number">60000</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">readTimeout</span><span class="token punctuation">(</span><span class="token number">60000</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        MediaType mediaType = MediaType.parse("text/plain");</span>
        <span class="token class-name">RequestBody</span> body <span class="token operator">=</span> <span class="token function">addFormParts</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MultipartBody<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token class-name">MultipartBody</span><span class="token punctuation">.</span>FORM<span class="token punctuation">)</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Request</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span>reqUrl<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Response</span> response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">newCall</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//返回响应体</span>
        <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> jsonObject<span class="token punctuation">.</span><span class="token function">toJavaObject</span><span class="token punctuation">(</span>tClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 处理人脸分析参数
     * @param faceDetectResponse: 人脸检测后的结果
     * @param type: 人脸分析类型，可以用于后期实现多种人脸分析方式
     * @method processFaceAttr
     * @return com.example.faceIdentity.data.CustomResponse&lt;com.example.faceIdentity.data.FaceGenericResponse>
     *
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">CustomResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FaceGenericResponse</span><span class="token punctuation">></span></span> <span class="token function">processFaceAttr</span><span class="token punctuation">(</span><span class="token class-name">FaceGenericResponse</span> faceDetectResponse<span class="token punctuation">,</span> <span class="token class-name">AttrType</span> type<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//创建基础响应体</span>
        <span class="token class-name">CustomResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FaceGenericResponse</span><span class="token punctuation">></span></span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//进行参数过滤</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>faceDetectResponse<span class="token punctuation">.</span><span class="token function">getFace_num</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            response<span class="token punctuation">.</span><span class="token function">setMsg</span><span class="token punctuation">(</span><span class="token string">"请保持镜头中有且仅有一个人"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> response<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">//分析人脸</span>
        <span class="token class-name">FaceGenericResponse</span> faceAnalyzeResponse <span class="token operator">=</span> <span class="token function">faceAnalyze</span><span class="token punctuation">(</span>faceDetectResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取分析参数</span>
        <span class="token class-name">FaceAttributes</span> faceAttributes <span class="token operator">=</span> faceAnalyzeResponse<span class="token punctuation">.</span><span class="token function">getFaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//进行参数分析过滤</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>faceAttributes<span class="token punctuation">.</span><span class="token function">getFacequality</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> faceAttributes<span class="token punctuation">.</span><span class="token function">getFacequality</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"threshold"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            response<span class="token punctuation">.</span><span class="token function">setMsg</span><span class="token punctuation">(</span><span class="token string">"人脸状况不适合于进行对比识别"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> response<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        response<span class="token punctuation">.</span><span class="token function">setMsg</span><span class="token punctuation">(</span><span class="token string">"人脸检测成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>faceAnalyzeResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token class-name">FaceGenericResponse</span> <span class="token function">faceAnalyze</span><span class="token punctuation">(</span><span class="token class-name">FaceGenericResponse</span> faceDetectResponse<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> face_token <span class="token operator">=</span> faceDetectResponse<span class="token punctuation">.</span><span class="token function">getFaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFace_token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FaceAnalyzeRequest</span> faceAnalyzeRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FaceAnalyzeRequest</span><span class="token punctuation">(</span>face_token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">processFace</span><span class="token punctuation">(</span>faceAnalyzeRequest<span class="token punctuation">,</span> <span class="token class-name">ApiService<span class="token punctuation">.</span>ApiType</span><span class="token punctuation">.</span>ANALYZE<span class="token punctuation">,</span> <span class="token class-name">FaceGenericResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="项目总结"><a href="#项目总结" class="headerlink" title="项目总结"></a>项目总结</h1><p>此 api 开发对于如何组织多种数据结构的项目有一定启示，同时也应用到了 java 常用的 http 请求库。对于文件上传，url 编码，数据映射等多方面均有涉及，可以作为一个 RESTFUl 接口项目调用第三方 api 的基础示例使用。</p>
<p>但是问题在于此接口上传图片又需要转发到第三方 api， 比较耗时间和流量，用户等待时间较长，更好的建议是使用多线程异步开发，api 得到结果后返回消息至控制器。</p>

            </div>

            <!-- Post Comments -->
            
    <!-- 使用 DISQUS_CLICK -->
<div id="disqus-comment">
    <div id="disqus_thread"></div>

<!-- add animation -->
<style>
	.disqus_click_btn {
            line-height: 30px;
            margin: 0;
            min-width: 50px;
            padding: 0 14px;
            display: inline-block;
            font-family: "Roboto", "Helvetica", "Arial", sans-serif;
            font-size: 14px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0;
            overflow: hidden;
            will-change: box-shadow;
            transition: box-shadow .2s cubic-bezier(.4, 0, 1, 1), background-color .2s cubic-bezier(.4, 0, .2, 1), color .2s cubic-bezier(.4, 0, .2, 1);
            outline: 0;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            vertical-align: middle;
            border: 0;
            background: rgba(158, 158, 158, .2);
            box-shadow: 0 2px 2px 0 rgba(0, 0, 0, .14), 0 3px 1px -2px rgba(0, 0, 0, .2), 0 1px 5px 0 rgba(0, 0, 0, .12);
            color: #fff;
            background-color: #7EC0EE;
            text-shadow: 0
        }
</style>
	
<div class="btn_click_load" id="disqus_bt"> 
    <button class="disqus_click_btn">点击查看评论</button>
</div>

<!--
<script type="text/javascript">
$('.btn_click_load').click(function() {
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'http-miccall-tech'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    document.getElementById('disqus_bt').style.display = "none";
});
</script>
-->
<script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://example.com/2022/03/04/springboot%E8%B0%83%E7%94%A8api%E5%AE%9E%E7%8E%B0%E6%95%99%E8%80%83%E5%B9%B3%E5%8F%B0%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB%E6%8E%A5%E5%8F%A3/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'http://example.com/2022/03/04/springboot%E8%B0%83%E7%94%A8api%E5%AE%9E%E7%8E%B0%E6%95%99%E8%80%83%E5%B9%B3%E5%8F%B0%E4%BA%BA%E8%84%B8%E8%AF%86%E5%88%AB%E6%8E%A5%E5%8F%A3/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
</script>

<script type="text/javascript">
    $('.btn_click_load').click(function() {  //click to load comments
        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document;
            var s = d.createElement('script');
            s.src = '//http-miccall-tech.disqus.com/embed.js';
            s.setAttribute('data-timestamp', + new Date());
            (d.head || d.body).appendChild(s);
        })();
        $('.btn_click_load').css('display','none');
    });
</script>
</div>
<style>
    #disqus-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>


        </div>
        <!-- Copyright 版权 start -->
                <div id="copyright">
            <ul>
                <li>&copy;Powered By <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/" style="border-bottom: none;">hexo</a></li>
                <li>Design: <a target="_blank" rel="noopener" href="http://miccall.tech " style="border-bottom: none;">miccall</a></li>
            </ul>
            
                <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
			
        </div>
    </div>
</body>




 	
</html>
